# 基于现有费用管理实现账单管理接口

## 1. 数据库结构分析

经过实际数据库检查，系统已经存在以下相关表格：

### 1.1 费用相关表

* `expenses` - 费用主表（对应账单）

* `expense_categories` - 费用分类表

* `expense_splits` - 费用分摊表

* `expense_reimbursements` - 费用报销表

* `budgets` - 预算表

* `budget_categories` - 预算分类表

### 1.2 用户相关表

* `users` - 用户表

* `roles` - 角色表

* `user_roles` - 用户角色关联表

### 1.3 缺少的表

* `contacts` - 联系人表（需要创建）

## 2. 现有功能分析

现有系统已经实现了大部分费用管理功能，对应账单管理需求：

| 用户需求    | 现有接口                                          | 状态      |
| ------- | --------------------------------------------- | ------- |
| 获取账单列表  | GET /api/expenses                             | ✅ 已实现   |
| 创建账单    | POST /api/expenses                            | ✅ 已实现   |
| 更新账单    | PUT /api/expenses/:id                         | ❌ 需要实现  |
| 删除账单    | DELETE /api/expenses/:id                      | ✅ 已实现   |
| 获取账单详情  | GET /api/expenses/:id                         | ✅ 已实现   |
| 标记支付    | PUT /api/expenses/:id/pay                     | ✅ 已实现   |
| 发送提醒    | POST /api/expenses/:id/remind                 | ❌ 需要实现  |
| 批量操作    | PUT /api/expenses/batch/approve/reject/delete | ✅ 部分已实现 |
| 导出账单    | GET /api/expenses/export                      | ✅ 已实现   |
| 获取统计数据  | GET /api/expenses/statistics                  | ❌ 需要实现  |
| 获取分类列表  | GET /api/categories                           | ❌ 需要实现  |
| 获取联系人列表 | GET /api/contacts                             | ❌ 需要实现  |

## 3. 实现步骤

### 3.1 创建联系人表

```sql
CREATE TABLE IF NOT EXISTS contacts (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    phone VARCHAR(20),
    company VARCHAR(255),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER NOT NULL,
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 3.2 实现联系人管理功能

* 创建 `models/ContactModel.js` - 联系人模型

* 创建 `services/ContactService.js` - 联系人服务

* 创建 `controllers/ContactController.js` - 联系人控制器

* 创建 `routes/contacts.js` - 联系人路由

### 3.3 补充费用管理功能

* 在 `ExpenseController.js` 中添加 `updateExpense` 方法 - 更新费用

* 在 `ExpenseController.js` 中添加 `sendReminder` 方法 - 发送提醒

* 在 `ExpenseController.js` 中添加 `getStatistics` 方法 - 获取统计数据

* 在 `expenses.js` 路由中添加对应的路由

### 3.4 实现分类管理功能

* 创建 `models/CategoryModel.js` - 分类模型

* 创建 `services/CategoryService.js` - 分类服务

* 创建 `controllers/CategoryController.js` - 分类控制器

* 创建 `routes/categories.js` - 分类路由

### 3.5 注册路由

* 在 `server.js` 中注册新创建的路由

## 4. 接口实现

### 4.1 账单相关接口（基于现有费用管理）

* `GET /api/bills` - 获取账单列表（重定向到 /api/expenses 或新增路由）

* `POST /api/bills` - 创建账单（重定向到 /api/expenses 或新增路由）

* `PUT /api/bills/:id` - 更新账单（新增）

* `DELETE /api/bills/:id` - 删除账单（重定向到 /api/expenses/:id 或新增路由）

* `GET /api/bills/:id` - 获取账单详情（重定向到 /api/expenses/:id 或新增路由）

* `POST /api/bills/:id/pay` - 标记支付（重定向到 /api/expenses/:id/pay 或新增路由）

* `POST /api/bills/:id/remind` - 发送提醒（新增）

* `POST /api/bills/batch` - 批量操作（新增，整合现有批量功能）

* `GET /api/bills/export` - 导出账单（重定向到 /api/expenses/export 或新增路由）

* `GET /api/bills/statistics` - 获取统计数据（新增）

### 4.2 分类相关接口

* `GET /api/categories` - 获取分类列表

* `POST /api/categories` - 创建分类（可选）

* `PUT /api/categories/:id` - 更新分类（可选）

* `DELETE /api/categories/:id` - 删除分类（可选）

### 4.3 联系人相关接口

* `GET /api/contacts` - 获取联系人列表

* `POST /api/contacts` - 创建联系人

* `PUT /api/contacts/:id` - 更新联系人

* `DELETE /api/contacts/:id` - 删除联系人

## 5. 实现要点

1. 所有接口都需要经过身份认证
2. 实现统一的响应格式 `{success: true, data: {}}`
3. 添加适当的日志记录
4. 实现输入验证
5. 处理错误情况
6. 实现分页和筛选功能
7. 确保接口性能
8. 保持与现有代码风格一致

## 6. 测试计划

1. 使用 Postman 测试每个接口
2. 测试各种边界情况
3. 测试错误处理
4. 测试分页和筛选功能
5. 测试身份认证

## 7. 集成到前端

确保前端代码正确调用这些接口，并处理好响应数据。

## 8.测试用户信息

* 用户名: 管理员

* 登录邮箱: <admin@example.com>

* 密码: Admin123.

* 角色: admin

