# 基于真实数据库的支付记录页面接口开发计划

## 一、数据库结构分析

### 现有核心表结构
1. **expenses** - 费用表
   - 存储所有费用记录
   - 包含字段：id, title, amount, status, payment_method, payment_date等

2. **qr_codes** - 收款码表
   - 存储收款码信息
   - 包含字段：id, name, type, amount, currency, description, platform, status等

3. **qr_payment_records** - 二维码支付记录表
   - 存储通过收款码进行的支付记录
   - 包含字段：id, qr_code_id, payer_id, amount, status, paid_at, transaction_id, payment_method等

4. **payment_logs** - 支付日志表
   - 记录支付操作日志
   - 包含字段：id, expense_id, payment_method, amount, transaction_id, status, created_at等

## 二、开发计划

### 1. 支付记录相关接口

#### 1.1 获取支付记录列表 - GET /api/payments
**实现方案**：
- 结合 `qr_payment_records` 和 `expenses` 表数据
- 支持多条件筛选和分页
- 返回格式：`{success: true, data: {records: PaymentRecord[], total: number, page: number, size: number, pages: number}}`

**核心SQL逻辑**：
```sql
SELECT 
  qpr.id, qpr.qr_code_id, qpr.payer_id, qpr.amount, qpr.status, 
  qpr.paid_at as paidAt, qpr.transaction_id as transactionId, 
  qpr.payment_method as paymentMethod, qpr.created_at as createdAt,
  e.title as description
FROM qr_payment_records qpr
LEFT JOIN expenses e ON qpr.expense_id = e.id
WHERE qpr.payer_id = $1
-- 动态添加筛选条件
ORDER BY qpr.created_at DESC
LIMIT $2 OFFSET $3
```

#### 1.2 获取支付记录详情 - GET /api/payments/:orderId
**实现方案**：
- 根据交易ID查询支付记录详情
- 关联查询收款码和费用信息

#### 1.3 获取支付统计数据 - GET /api/payments/statistics
**实现方案**：
- 统计总收入、总支出、交易笔数等
- 从 `qr_payment_records` 表中聚合数据

#### 1.4 导出支付记录 - GET /api/payments/export
**实现方案**：
- 支持CSV和Excel格式
- 基于获取支付记录列表的逻辑，添加导出功能

### 2. 收入趋势和支付方式分布接口

#### 2.1 获取收入趋势数据 - GET /api/payments/income-trend
**实现方案**：
- 按月统计收入数据
- 从 `qr_payment_records` 表中聚合

#### 2.2 获取支付方式分布数据 - GET /api/payments/method-distribution
**实现方案**：
- 按支付方式统计交易笔数和金额占比
- 从 `qr_payment_records` 表中聚合

### 3. 收款码相关接口

#### 3.1 优化现有收款码接口
**实现方案**：
- 复用现有 `PaymentController` 中的收款码相关方法
- 确保返回格式符合前端需求
- 调整路由路径以匹配前端期望

#### 3.2 新增上传收款码图片接口 - POST /api/qr-codes/upload
**实现方案**：
- 支持上传图片文件
- 生成收款码URL
- 保存到 `qr_codes` 表

### 4. 支付操作接口

#### 4.1 创建支付订单 - POST /api/payments
**实现方案**：
- 生成支付订单
- 记录到 `qr_payment_records` 表
- 返回订单信息和支付链接/二维码

#### 4.2 确认支付 - POST /api/payments/:orderId/confirm
**实现方案**：
- 复用现有 `confirmPayment` 方法
- 调整路由路径

### 5. 安全相关接口

#### 5.1 收款码安全检测 - POST /api/qr-codes/security-check
**实现方案**：
- 检查收款码状态、过期时间、使用次数等
- 返回安全检测结果

#### 5.2 获取安全检测历史记录 - GET /api/qr-codes/security-history
**实现方案**：
- 记录收款码安全检测历史
- 从 `qr_codes` 表中查询历史数据

### 6. 提醒设置和费用分摊接口

#### 6.1 保存提醒设置 - POST /api/payments/reminder-settings
**实现方案**：
- 保存用户提醒设置
- 创建 `reminder_settings` 表（如果不存在）

#### 6.2 计算费用分摊 - POST /api/payments/calculate-sharing
**实现方案**：
- 基于费用和成员数据计算分摊
- 不修改数据库，仅返回计算结果

## 三、开发步骤

### 1. 准备工作
- 创建必要的数据库表（如果不存在）
- 配置路由文件
- 准备基础工具函数

### 2. 核心功能实现
- 实现支付记录列表和详情接口
- 实现支付统计数据接口
- 实现收入趋势和支付方式分布接口

### 3. 优化现有功能
- 优化收款码相关接口
- 调整路由路径以匹配前端期望
- 确保返回格式统一

### 4. 新增功能实现
- 实现上传收款码图片接口
- 实现安全相关接口
- 实现提醒设置和费用分摊接口

### 5. 测试和优化
- 测试所有接口
- 优化性能
- 修复bug

## 四、技术规范

1. **响应格式**：统一使用 `{success: true, data: {...}}` 格式
2. **错误处理**：完善的错误捕获和友好的错误信息
3. **参数验证**：对所有API参数进行严格验证
4. **日志记录**：关键操作记录日志
5. **安全性**：实现适当的权限控制

## 五、路由配置

### 现有路由调整
1. 将现有的 `/api/payment` 路由调整为 `/api/payments`
2. 保留现有的 `/api/qr-codes` 路由

### 新增路由
1. `/api/payments/income-trend` - 获取收入趋势数据
2. `/api/payments/method-distribution` - 获取支付方式分布数据
3. `/api/payments/reminder-settings` - 保存提醒设置
4. `/api/payments/calculate-sharing` - 计算费用分摊
5. `/api/qr-codes/security-check` - 收款码安全检测
6. `/api/qr-codes/security-history` - 获取安全检测历史记录

## 六、预期交付成果

1. 完整的支付记录页面接口实现
2. 符合前端需求的API返回格式
3. 详细的API文档
4. 测试报告

## 七、风险评估与应对

1. **数据一致性风险**：使用事务确保数据一致性
2. **性能风险**：对查询接口实现分页和索引优化
3. **兼容性风险**：确保接口兼容不同的前端请求方式
4. **安全风险**：实现严格的权限控制和数据验证

## 八、后续优化方向

1. 实现接口缓存，提高查询性能
2. 增加更多的数据分析维度
3. 实现更复杂的安全检测逻辑
4. 支持更多的支付方式和导出格式
5. 实现实时支付通知功能