# 系统设置页面接口设计方案

## 一、项目背景与数据库结构分析

### 1.1 现有数据库表结构

基于对数据库的实际检查，以下是系统设置相关的核心表结构：

**1. admin\_system\_configs（系统配置表）**

* 字段：id, config\_key, config\_value, data\_type, config\_group, display\_name, description, is\_encrypted, created\_at, updated\_at

* 用途：存储所有可动态调整的系统参数

**2. admin\_config\_audit\_logs（配置审计日志表）**

* 字段：id, config\_key, old\_value, new\_value, change\_type, changed\_by, changed\_by\_username, ip\_address, user\_agent, reason, is\_rollback, created\_at

* 用途：记录所有配置变更操作

**3. admin\_config\_history（配置历史表）**

* 字段：id, config\_key, config\_value, config\_version, changed\_by, changed\_by\_username, change\_reason, created\_at

* 用途：保存配置的历史版本

**4. contacts（联系人表）**

* 字段：id, name, email, phone, company, description, created\_by, created\_at, updated\_at

* 用途：存储系统通知接收人信息

### 1.2 现有API接口（已存在）

* `GET /api/system/config` - 获取所有系统配置

* `PUT /api/system/config` - 批量更新配置

* `GET /api/system/config/groups` - 获取配置分组

* `POST /api/system/config` - 创建/更新单个配置

* `DELETE /api/system/config/:key` - 禁用配置

* `POST /api/system/config/:key/reset` - 重置配置为默认值

### 1.3 页面功能需求分析

系统设置页面包含以下功能模块：

1. **基本设置**：系统名称、描述、Logo、主题、语言
2. **支付设置**：支付宝、微信、银联支付配置
3. **邮件设置**：SMTP服务器配置
4. **安全设置**：密码策略、登录限制、双因素认证
5. **通知设置**：通知规则、通知模板管理
6. **系统信息**：版本、环境、运行时长、服务状态
7. **业务规则**：逾期宽限期、滞纳金、退款规则
8. **日志设置**：日志级别、保留策略、轮转配置

## 二、接口设计方案

### 2.1 接口清单（共22个接口）

#### 基础配置类接口

| 接口名称   | 功能描述          | 请求方法 | URL路径                                    |
| ------ | ------------- | ---- | ---------------------------------------- |
| 获取系统配置 | 获取指定分组的所有系统配置 | GET  | /api/admin/settings/configs/:group       |
| 更新系统配置 | 批量更新系统配置项     | PUT  | /api/admin/settings/configs              |
| 重置配置   | 将指定配置重置为默认值   | POST | /api/admin/settings/configs/:key/reset   |
| 获取配置历史 | 获取配置的历史变更记录   | GET  | /api/admin/settings/configs/:key/history |

#### 支付配置类接口

| 接口名称   | 功能描述       | 请求方法 | URL路径                                       |
| ------ | ---------- | ---- | ------------------------------------------- |
| 获取支付配置 | 获取所有支付方式配置 | GET  | /api/admin/settings/payment/configs         |
| 更新支付配置 | 更新指定支付方式配置 | PUT  | /api/admin/settings/payment/configs/:method |
| 测试支付配置 | 测试支付通道连接状态 | POST | /api/admin/settings/payment/test            |

#### 邮件配置类接口

| 接口名称   | 功能描述        | 请求方法 | URL路径                            |
| ------ | ----------- | ---- | -------------------------------- |
| 获取邮件配置 | 获取SMTP邮件配置  | GET  | /api/admin/settings/email/config |
| 更新邮件配置 | 更新SMTP邮件配置  | PUT  | /api/admin/settings/email/config |
| 测试邮件配置 | 测试SMTP连接和发送 | POST | /api/admin/settings/email/test   |

#### 安全配置类接口

| 接口名称   | 功能描述     | 请求方法 | URL路径                               |
| ------ | -------- | ---- | ----------------------------------- |
| 获取安全配置 | 获取安全策略配置 | GET  | /api/admin/settings/security/config |
| 更新安全配置 | 更新安全策略配置 | PUT  | /api/admin/settings/security/config |

#### 通知模板类接口

| 接口名称     | 功能描述     | 请求方法   | URL路径                                          |
| -------- | -------- | ------ | ---------------------------------------------- |
| 获取通知模板列表 | 获取所有通知模板 | GET    | /api/admin/settings/notification/templates     |
| 创建通知模板   | 新建通知模板   | POST   | /api/admin/settings/notification/templates     |
| 更新通知模板   | 更新通知模板   | PUT    | /api/admin/settings/notification/templates/:id |
| 删除通知模板   | 删除通知模板   | DELETE | /api/admin/settings/notification/templates/:id |

#### 通知规则类接口

| 接口名称    | 功能描述      | 请求方法 | URL路径                                       |
| ------- | --------- | ---- | ------------------------------------------- |
| 获取通知规则  | 获取通知规则配置  | GET  | /api/admin/settings/notification/rules      |
| 更新通知规则  | 更新通知规则配置  | PUT  | /api/admin/settings/notification/rules      |
| 获取通知接收人 | 获取通知接收人列表 | GET  | /api/admin/settings/notification/recipients |
| 更新通知接收人 | 更新通知接收人配置 | PUT  | /api/admin/settings/notification/recipients |

#### 业务规则类接口

| 接口名称   | 功能描述     | 请求方法 | URL路径                              |
| ------ | -------- | ---- | ---------------------------------- |
| 获取业务规则 | 获取业务规则配置 | GET  | /api/admin/settings/business/rules |
| 更新业务规则 | 更新业务规则配置 | PUT  | /api/admin/settings/business/rules |

#### 日志配置类接口

| 接口名称   | 功能描述   | 请求方法 | URL路径                           |
| ------ | ------ | ---- | ------------------------------- |
| 获取日志配置 | 获取日志配置 | GET  | /api/admin/settings/logs/config |
| 更新日志配置 | 更新日志配置 | PUT  | /api/admin/settings/logs/config |

#### 系统信息类接口

| 接口名称   | 功能描述     | 请求方法 | URL路径                               |
| ------ | -------- | ---- | ----------------------------------- |
| 获取系统信息 | 获取系统运行信息 | GET  | /api/admin/settings/system/info     |
| 获取服务状态 | 获取各服务状态  | GET  | /api/admin/settings/system/services |

### 2.2 详细接口设计

#### 接口1：获取系统配置

* **接口名称**：获取系统配置

* **功能描述**：获取指定配置分组的系统配置信息

* **请求方法**：GET

* **URL路径**：/api/admin/settings/configs/:group

* **请求头**：Authorization: Bearer {token}

* **请求参数**：

  | 参数名称  | 数据类型   | 是否必填 | 默认值 | 说明                                                          |
  | ----- | ------ | ---- | --- | ----------------------------------------------------------- |
  | group | string | 是    | -   | 配置分组：basic/payment/email/security/notification/business/log |

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "configs": {
          "system.name": { "value": "AI记账管理系统", "displayName": "系统名称", "description": "系统的显示名称", "dataType": "string" },
          "system.logo": { "value": "https://example.com/logo.png", "displayName": "系统Logo", "description": "系统Logo图片地址", "dataType": "string" },
          "system.theme": { "value": "default", "displayName": "默认主题", "description": "系统默认主题", "dataType": "string" },
          "system.language": { "value": "zh-CN", "displayName": "系统语言", "description": "系统默认语言", "dataType": "string" }
        },
        "group": "basic",
        "updatedAt": "2026-01-06T10:30:00.000Z"
      }
    }
    ```

  * 失败响应（400/404/500）：错误码和错误描述

* **数据处理逻辑**：

  * 从admin\_system\_configs表查询指定分组的配置

  * 按config\_key排序返回

  * 解析config\_value为JSON格式

* **错误处理**：

  * 400：参数验证失败

  * 404：配置分组不存在

  * 500：服务器内部错误

#### 接口2：更新系统配置

* **接口名称**：更新系统配置

* **功能描述**：批量更新系统配置项

* **请求方法**：PUT

* **URL路径**：/api/admin/settings/configs

* **请求头**：Authorization: Bearer {token}, Content-Type: application/json

* **请求参数**：

  | 参数名称    | 数据类型   | 是否必填 | 默认值 | 说明      |
  | ------- | ------ | ---- | --- | ------- |
  | configs | object | 是    | -   | 配置键值对对象 |
  | reason  | string | 否    | -   | 配置变更原因  |

* **请求体示例**：

  ```json
  {
    "configs": {
      "system.name": "新的系统名称",
      "system.theme": "dark",
      "system.language": "en-US"
    },
    "reason": "更新系统基本配置"
  }
  ```

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "message": "配置更新成功",
        "results": [
          { "key": "system.name", "success": true, "version": 2 },
          { "key": "system.theme", "success": true, "version": 1 },
          { "key": "system.language", "success": true, "version": 3 }
        ],
        "restartRequired": []
      }
    }
    ```

* **数据处理逻辑**：

  * 验证configs对象格式

  * 遍历调用systemConfigService.setConfig更新每个配置

  * 记录配置变更到admin\_config\_audit\_logs表

  * 保存配置历史到admin\_config\_history表

  * 清除相关缓存

* **错误处理**：

  * 400：请求体格式错误

  * 500：批量更新失败

#### 接口3：获取支付配置

* **接口名称**：获取支付配置

* **功能描述**：获取所有支付方式的配置信息

* **请求方法**：GET

* **URL路径**：/api/admin/settings/payment/configs

* **请求头**：Authorization: Bearer {token}

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "enabledPayments": ["alipay", "wechat"],
        "defaultPayment": "alipay",
        "configs": {
          "alipay": {
            "appId": "your-alipay-appid",
            "merchantId": "your-merchant-id",
            "enabled": true
          },
          "wechat": {
            "appId": "your-wechat-appid",
            "merchantId": "your-merchant-id",
            "enabled": true
          },
          "unionpay": {
            "appId": "",
            "merchantId": "",
            "enabled": false
          }
        }
      }
    }
    ```

#### 接口4：测试支付配置

* **接口名称**：测试支付配置

* **功能描述**：测试指定支付通道的连接状态

* **请求方法**：POST

* **URL路径**：/api/admin/settings/payment/test

* **请求体**：

  ```json
  {
    "method": "alipay",
    "config": {
      "appId": "test-appid",
      "merchantId": "test-merchant-id"
    }
  }
  ```

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "message": "支付配置测试成功",
        "responseTime": "45ms",
        "status": "connected"
      }
    }
    ```

#### 接口5：获取邮件配置

* **接口名称**：获取邮件配置

* **功能描述**：获取SMTP邮件服务器配置

* **请求方法**：GET

* **URL路径**：/api/admin/settings/email/config

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "smtpServer": "smtp.example.com",
        "smtpPort": 587,
        "emailAccount": "admin@example.com",
        "senderName": "系统管理员",
        "secureConnection": true
      }
    }
    ```

#### 接口6：测试邮件配置

* **接口名称**：测试邮件配置

* **功能描述**：测试SMTP服务器连接和邮件发送

* **请求方法**：POST

* **URL路径**：/api/admin/settings/email/test

* **请求体**：

  ```json
  {
    "testEmail": "test@example.com",
    "config": {
      "smtpServer": "smtp.example.com",
      "smtpPort": 587,
      "emailAccount": "admin@example.com",
      "emailPassword": "password"
    }
  }
  ```

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "message": "邮件测试发送成功",
        "responseTime": "1200ms"
      }
    }
    ```

#### 接口7：获取安全配置

* **接口名称**：获取安全配置

* **功能描述**：获取密码策略、安全限制等配置

* **请求方法**：GET

* **URL路径**：/api/admin/settings/security/config

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "passwordStrength": "medium",
        "loginFailCount": 5,
        "lockTime": 30,
        "sessionTimeout": 120,
        "twoFactorAuth": false,
        "ipRestriction": false,
        "passwordPolicy": {
          "minLength": 8,
          "requireSpecial": true,
          "requireNumber": true,
          "requireUppercase": true
        }
      }
    }
    ```

#### 接口8：获取通知模板列表

* **接口名称**：获取通知模板列表

* **功能描述**：获取所有通知模板

* **请求方法**：GET

* **URL路径**：/api/admin/settings/notification/templates

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "templates": [
          {
            "id": 1,
            "name": "费用缴纳通知",
            "type": "email",
            "content": "尊敬的{userName}，您有一笔{amount}元的{feeType}费用待缴纳，请在{dueDate}前完成支付。",
            "variables": ["{userName}", "{amount}", "{feeType}", "{dueDate}"],
            "createdAt": "2026-01-01T10:00:00.000Z",
            "updatedAt": "2026-01-05T15:30:00.000Z"
          }
        ],
        "total": 3
      }
    }
    ```

#### 接口9：创建通知模板

* **接口名称**：创建通知模板

* **功能描述**：新建通知模板

* **请求方法**：POST

* **URL路径**：/api/admin/settings/notification/templates

* **请求体**：

  ```json
  {
    "name": "新模板名称",
    "type": "email",
    "content": "模板内容，支持变量替换：{userName}, {amount}"
  }
  ```

#### 接口10：更新通知模板

* **接口名称**：更新通知模板

* **功能描述**：更新指定通知模板

* **请求方法**：PUT

* **URL路径**：/api/admin/settings/notification/templates/:id

* **请求体**：同创建模板

#### 接口11：删除通知模板

* **接口名称**：删除通知模板

* **功能描述**：删除指定通知模板

* **请求方法**：DELETE

* **URL路径**：/api/admin/settings/notification/templates/:id

#### 接口12：获取通知规则

* **接口名称**：获取通知规则

* **功能描述**：获取系统通知规则配置

* **请求方法**：GET

* **URL路径**：/api/admin/settings/notification/rules

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "systemNotifications": ["email", "wechat"],
        "importantOperationNotify": true,
        "scheduledTaskNotify": true,
        "alertNotify": true
      }
    }
    ```

#### 接口13：获取通知接收人

* **接口名称**：获取通知接收人

* **功能描述**：获取通知接收人列表

* **请求方法**：GET

* **URL路径**：/api/admin/settings/notification/recipients

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "recipients": [
          { "id": 1, "name": "张三", "email": "zhangsan@example.com", "role": "管理员" },
          { "id": 2, "name": "李四", "email": "lisi@example.com", "role": "财务" }
        ]
      }
    }
    ```

#### 接口14：获取业务规则

* **接口名称**：获取业务规则

* **功能描述**：获取业务规则配置

* **请求方法**：GET

* **URL路径**：/api/admin/settings/business/rules

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "overdueGracePeriod": 7,
        "lateFeeCalculation": "daily",
        "lateFeeRate": 0.05,
        "maxLateFee": 1000,
        "refundPeriod": 30,
        "refundFeeRate": 2
      }
    }
    ```

#### 接口15：获取日志配置

* **接口名称**：获取日志配置

* **功能描述**：获取日志配置信息

* **请求方法**：GET

* **URL路径**：/api/admin/settings/logs/config

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "level": "info",
        "retentionDays": 30,
        "maxFileSize": 100,
        "rotationEnabled": true,
        "outputTargets": ["file", "console"]
      }
    }
    ```

#### 接口16：获取系统信息

* **接口名称**：获取系统信息

* **功能描述**：获取系统基本信息

* **请求方法**：GET

* **URL路径**：/api/admin/settings/system/info

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "name": "AI记账管理系统",
        "version": "2.1.0",
        "environment": "development",
        "startTime": "2026-01-06T08:00:00.000Z",
        "uptime": "2天5小时30分钟"
      }
    }
    ```

#### 接口17：获取服务状态

* **接口名称**：获取服务状态

* **功能描述**：获取各服务组件状态

* **请求方法**：GET

* **URL路径**：/api/admin/settings/system/services

* **响应格式**：

  * 成功响应（200）：

    ```json
    {
      "success": true,
      "data": {
        "services": [
          { "name": "用户服务", "status": "正常", "responseTime": "45ms" },
          { "name": "费用服务", "status": "正常", "responseTime": "62ms" },
          { "name": "支付服务", "status": "正常", "responseTime": "78ms" },
          { "name": "通知服务", "status": "正常", "responseTime": "32ms" },
          { "name": "数据库服务", "status": "正常", "responseTime": "15ms" }
        ],
        "checkedAt": "2026-01-06T10:30:00.000Z"
      }
    }
    ```

### 2.3 错误码定义

| 错误码  | 错误信息    | 说明         |
| ---- | ------- | ---------- |
| 400  | 参数验证失败  | 请求参数不合法    |
| 401  | 未授权访问   | Token无效或过期 |
| 403  | 权限不足    | 需要管理员权限    |
| 404  | 资源不存在   | 配置项或模板不存在  |
| 500  | 服务器内部错误 | 系统错误       |
| 1001 | 配置更新失败  | 更新配置时发生错误  |
| 1002 | 配置不存在   | 指定的配置键不存在  |
| 1003 | 测试连接失败  | 网络连接测试失败   |
| 2001 | 模板创建失败  | 创建通知模板失败   |
| 2002 | 模板更新失败  | 更新通知模板失败   |
| 2003 | 模板删除失败  | 删除通知模板失败   |

## 三、数据库设计

### 3.1 新增通知模板表

需要创建通知模板表（如果不存在）：

```sql
CREATE TABLE IF NOT EXISTS admin_notification_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(20) NOT NULL CHECK (type IN ('email', 'sms', 'wechat', 'dingtalk')),
    content TEXT NOT NULL,
    variables JSONB DEFAULT '[]',
    is_active BOOLEAN DEFAULT TRUE,
    created_by INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_notification_templates_type ON admin_notification_templates(type);
CREATE INDEX IF NOT EXISTS idx_notification_templates_active ON admin_notification_templates(is_active);
```

## 四、实施计划

### 阶段1：创建后端路由文件

* 创建 /api/admin/settings/configs/\* 相关路由

* 创建 /api/admin/settings/payment/\* 相关路由

* 创建 /api/admin/settings/email/\* 相关路由

* 创建 /api/admin/settings/security/\* 相关路由

* 创建 /api/admin/settings/notification/\* 相关路由

* 创建 /api/admin/settings/business/\* 相关路由

* 创建 /api/admin/settings/logs/\* 相关路由

* 创建 /api/admin/settings/system/\* 相关路由

### 阶段2：创建前端API文件

* 创建 /api/admin/settings.ts 统一管理设置相关API

### 阶段3：更新前端页面

* 修改 SystemSettings.vue 使用新的API接口

* 实现各功能模块的数据交互

### 阶段4：测试验证

* 测试所有接口功能

* 验证前后端数据交互正确性

## 五、注意事项

1. **安全性**：所有接口需要管理员权限验证
2. **数据验证**：对所有输入参数进行严格验证
3. **审计记录**：配置变更需要记录审计日志
4. **缓存处理**：配置更新后需要清除相关缓存
5. **兼容性**：确保与现有系统配置表结构兼容

