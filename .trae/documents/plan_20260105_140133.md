# 管理端收款码管理页面接口设计方案

## 一、数据库结构分析与扩展

### 1.1 现有表结构

基于 `create-qr-codes-tables.sql` 和数据库查询，`qr_codes` 表包含：

* 基础字段：id, name, type, amount, currency, description, status, usage\_limit, usage\_count

* 时间字段：created\_at, updated\_at, expires\_at

* 图片字段：qr\_code\_url, logo\_url

* 商户字段：merchant\_name, merchant\_account

* 平台字段：platform (alipay/wechat/unionpay)

* 其他：is\_default, tags, background\_color, is\_user\_uploaded, user\_id

### 1.2 需要的扩展字段

根据前端页面需求，需要新增或计算以下字段：

* **securityStatus**: 安全状态 (safe/risk/abnormal) - 需新增字段或实时计算

* **auditStatus**: 审核状态 (pending/approved/rejected) - 需新增字段

* **account**: 收款账户 (映射 merchant\_account)

* **lastUsedTime**: 最后使用时间 (从 qr\_payment\_records 表关联查询)

* **qrCodeUrls**: 收款码图片数组 (原 qr\_code\_url 为单张，需支持多张)

***

## 二、接口设计总览

### 2.1 接口列表

| 接口名称     | 方法     | 路径                                            | 功能描述          |
| -------- | ------ | --------------------------------------------- | ------------- |
| 获取收款码列表  | GET    | /api/admin/payment-codes                      | 分页查询+多条件筛选    |
| 获取收款码详情  | GET    | /api/admin/payment-codes/:id                  | 获取单个收款码完整信息   |
| 创建收款码    | POST   | /api/admin/payment-codes                      | 新增收款码         |
| 更新收款码    | PUT    | /api/admin/payment-codes/:id                  | 编辑收款码信息       |
| 删除收款码    | DELETE | /api/admin/payment-codes/:id                  | 删除收款码         |
| 停用/启用收款码 | PUT    | /api/admin/payment-codes/:id/status           | 修改收款码状态       |
| 批量删除收款码  | POST   | /api/admin/payment-codes/batch-delete         | 批量删除          |
| 批量停用收款码  | POST   | /api/admin/payment-codes/batch-disable        | 批量停用          |
| 单个安全检查   | POST   | /api/admin/payment-codes/:id/security-check   | 执行单个收款码安全检查   |
| 批量安全检查   | POST   | /api/admin/payment-codes/batch-security-check | 批量执行安全检查      |
| 获取安全检查报告 | GET    | /api/admin/payment-codes/:id/security-report  | 获取单个收款码安全检查报告 |
| 获取使用统计   | GET    | /api/admin/payment-codes/:id/usage-statistics | 获取收款码使用统计数据   |
| 上传收款码图片  | POST   | /api/admin/payment-codes/upload               | 上传收款码图片       |
| 获取统计数据   | GET    | /api/admin/payment-codes/statistics           | 获取收款码管理统计数据   |

***

## 三、详细接口设计

### 3.1 获取收款码列表

**接口路径**: `GET /api/admin/payment-codes`

**请求参数**:

| 参数名            | 类型     | 必填 | 说明                                  |
| -------------- | ------ | -- | ----------------------------------- |
| page           | number | 否  | 页码，默认1                              |
| size           | number | 否  | 每页数量，默认10                           |
| name           | string | 否  | 收款码名称（模糊搜索）                         |
| type           | string | 否  | 收款码类型：alipay/wechat/unionpay        |
| status         | string | 否  | 状态：enabled/disabled/pending/stopped |
| securityStatus | string | 否  | 安全状态：safe/risk/abnormal             |
| auditStatus    | string | 否  | 审核状态：pending/approved/rejected      |
| startDate      | string | 否  | 创建开始日期 (YYYY-MM-DD)                 |
| endDate        | string | 否  | 创建结束日期 (YYYY-MM-DD)                 |

**响应格式**:

```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": 1,
        "name": "学费收款码",
        "type": "alipay",
        "account": "alipay@school.edu.cn",
        "qrCodeUrls": [
          "https://picsum.photos/seed/alipay1/200/200",
          "https://picsum.photos/seed/alipay2/200/200"
        ],
        "status": "enabled",
        "securityStatus": "safe",
        "auditStatus": "approved",
        "usageCount": 128,
        "lastUsedTime": "2023-10-15 14:30:25",
        "createTime": "2023-01-01 10:00:00",
        "remark": "用于收取学费"
      }
    ],
    "total": 100,
    "page": 1,
    "size": 10,
    "pages": 10
  },
  "message": "获取收款码列表成功"
}
```

***

### 3.2 获取收款码详情

**接口路径**: `GET /api/admin/payment-codes/:id`

**响应格式**:

```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "学费收款码",
    "type": "alipay",
    "account": "alipay@school.edu.cn",
    "qrCodeUrls": [
      "https://picsum.photos/seed/alipay1/200/200",
      "https://picsum.photos/seed/alipay2/200/200"
    ],
    "status": "enabled",
    "securityStatus": "safe",
    "auditStatus": "approved",
    "usageCount": 128,
    "lastUsedTime": "2023-10-15 14:30:25",
    "createTime": "2023-01-01 10:00:00",
    "remark": "用于收取学费",
    "merchantName": "学校财务处",
    "merchantAccount": "alipay@school.edu.cn",
    "platform": "alipay",
    "userId": 100,
    "userName": "张三",
    "lastCheckTime": "2023-10-15 15:30:00",
    "lastCheckResult": "safe"
  },
  "message": "获取收款码详情成功"
}
```

***

### 3.3 创建收款码

**接口路径**: `POST /api/admin/payment-codes`

**请求参数**:

| 参数名        | 类型        | 必填 | 说明                           |
| ---------- | --------- | -- | ---------------------------- |
| name       | string    | 是  | 收款码名称                        |
| type       | string    | 是  | 收款码类型：alipay/wechat/unionpay |
| account    | string    | 是  | 收款账户                         |
| qrCodeUrls | string\[] | 是  | 收款码图片URL数组                   |
| status     | string    | 否  | 状态，默认 enabled                |
| remark     | string    | 否  | 备注                           |
| userId     | number    | 否  | 指定所属用户，不传则创建系统收款码            |

***

### 3.4 更新收款码

**接口路径**: `PUT /api/admin/payment-codes/:id`

**请求参数**:

| 参数名         | 类型        | 必填 | 说明         |
| ----------- | --------- | -- | ---------- |
| name        | string    | 否  | 收款码名称      |
| type        | string    | 否  | 收款码类型      |
| account     | string    | 否  | 收款账户       |
| qrCodeUrls  | string\[] | 否  | 收款码图片URL数组 |
| status      | string    | 否  | 状态         |
| auditStatus | string    | 否  | 审核状态       |
| remark      | string    | 否  | 备注         |

***

### 3.5 删除收款码

**接口路径**: `DELETE /api/admin/payment-codes/:id`

**响应**:

```json
{
  "success": true,
  "message": "删除收款码成功"
}
```

***

### 3.6 修改收款码状态

**接口路径**: `PUT /api/admin/payment-codes/:id/status`

**请求参数**:

```json
{
  "status": "stopped"
}
```

**说明**: status 可选值：enabled(启用)、disabled(禁用)、pending(审核中)、stopped(已停用)

***

### 3.7 批量删除

**接口路径**: `POST /api/admin/payment-codes/batch-delete`

**请求参数**:

```json
{
  "ids": [1, 2, 3]
}
```

***

### 3.8 批量安全检查

**接口路径**: `POST /api/admin/payment-codes/batch-security-check`

**请求参数**:

```json
{
  "ids": [1, 2, 3]
}
```

**响应**:

```json
{
  "success": true,
  "data": {
    "successCount": 2,
    "failCount": 1,
    "results": [
      {
        "id": 1,
        "securityStatus": "safe",
        "riskLevel": "无",
        "issuesCount": 0
      },
      {
        "id": 2,
        "securityStatus": "risk",
        "riskLevel": "中等",
        "issuesCount": 2
      }
    ]
  },
  "message": "批量安全检查完成"
}
```

***

### 3.9 单个安全检查

**接口路径**: `POST /api/admin/payment-codes/:id/security-check`

**响应**:

```json
{
  "success": true,
  "data": {
    "checkTime": "2023-10-15 15:30:00",
    "result": "risk",
    "riskLevel": "中等",
    "checkItems": 12,
    "issuesFound": 2,
    "details": [
      {
        "item": "二维码有效性",
        "status": "pass",
        "description": "二维码可正常识别"
      },
      {
        "item": "账户状态",
        "status": "pass",
        "description": "收款账户状态正常"
      },
      {
        "item": "风控检测",
        "status": "warning",
        "description": "近期有异常交易记录"
      },
      {
        "item": "安全证书",
        "status": "fail",
        "description": "SSL证书即将过期"
      }
    ]
  },
  "message": "安全检查完成"
}
```

***

### 3.10 获取统计数据

**接口路径**: `GET /api/admin/payment-codes/statistics`

**响应**:

```json
{
  "success": true,
  "data": {
    "total": 100,
    "enabled": 60,
    "disabled": 20,
    "pending": 15,
    "stopped": 5,
    "safe": 80,
    "risk": 15,
    "abnormal": 5,
    "approved": 75,
    "rejected": 10,
    "pendingAudit": 15,
    "totalUsage": 12580,
    "todayUsage": 128
  },
  "message": "获取统计数据成功"
}
```

***

## 四、实现方案

### 4.1 新建控制器文件

* 路径: `AI-server/controllers/AdminPaymentCodeController.js`

### 4.2 新建路由文件

* 路径: `AI-server/routes/adminPaymentCodes.js`

### 4.3 数据库扩展

需要执行的SQL扩展语句（待确认后提供）

### 4.4 前端API服务文件

* 路径: `AI-admin/src/api/paymentCode.ts`

***

## 五、权限与安全

* 所有接口需要管理员权限 (adminAuth.requireAdmin)

* 敏感操作记录审计日志

* 图片URL存储和访问安全控制

