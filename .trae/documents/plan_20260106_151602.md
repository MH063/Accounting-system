# 费用类型管理接口设计方案

## 一、数据库扩展方案

### 1.1 扩展 expense\_categories 表

```sql
-- 为 expense_categories 表添加新字段
ALTER TABLE expense_categories 
ADD COLUMN IF NOT EXISTS default_amount DECIMAL(10, 2) DEFAULT 0.00,
ADD COLUMN IF NOT EXISTS billing_cycle VARCHAR(20) DEFAULT 'one-time',
ADD COLUMN IF NOT EXISTS allocation_rule VARCHAR(20) DEFAULT 'none';
```

**新字段说明**：

| 字段名              | 数据类型          | 默认值        | 说明                                     |
| ---------------- | ------------- | ---------- | -------------------------------------- |
| default\_amount  | DECIMAL(10,2) | 0.00       | 默认金额                                   |
| billing\_cycle   | VARCHAR(20)   | 'one-time' | 计费周期: one-time/monthly/semester/yearly |
| allocation\_rule | VARCHAR(20)   | 'none'     | 分摊规则: average/dormitory/none           |

**业务约束**：

* `category_code` 字段添加 UNIQUE 约束（如果尚未存在）

* `billing_cycle` 只允许: one-time, monthly, semester, yearly

* `allocation_rule` 只允许: average, dormitory, none

***

## 二、接口完整设计方案

### 2.1 接口概览

| 接口名称     | 方法     | URL                         | 功能描述         |
| -------- | ------ | --------------------------- | ------------ |
| 获取费用类型列表 | GET    | `/api/fee-types`            | 分页查询、搜索、排序   |
| 获取费用类型详情 | GET    | `/api/fee-types/:id`        | 获取单个费用类型详情   |
| 新增费用类型   | POST   | `/api/fee-types`            | 创建新的费用类型     |
| 编辑费用类型   | PUT    | `/api/fee-types/:id`        | 更新费用类型信息     |
| 删除费用类型   | DELETE | `/api/fee-types/:id`        | 删除费用类型（检查引用） |
| 更新状态     | PUT    | `/api/fee-types/:id/status` | 启用/禁用费用类型    |
| 导入费用类型   | POST   | `/api/fee-types/import`     | Excel批量导入    |
| 导出费用类型   | GET    | `/api/fee-types/export`     | Excel导出      |

***

### 2.2 详细接口设计

#### 接口1：获取费用类型列表

**请求信息**：

* **方法**: GET

* **URL**: `/api/fee-types`

* **Content-Type**: application/json

**请求参数** (Query Parameters):

| 参数名            | 类型     | 必填 | 说明                                      |
| -------------- | ------ | -- | --------------------------------------- |
| page           | number | 否  | 页码，默认1                                  |
| pageSize       | number | 否  | 每页条数，默认10                               |
| search         | string | 否  | 搜索关键词（匹配名称、编码、描述）                       |
| status         | string | 否  | 状态筛选: enabled/disabled                  |
| billingCycle   | string | 否  | 计费周期筛选                                  |
| allocationRule | string | 否  | 分摊规则筛选                                  |
| sortBy         | string | 否  | 排序字段: name/code/created\_at/sort\_order |
| sortOrder      | string | 否  | 排序方向: asc/desc                          |

**请求示例**:

```
GET /api/fee-types?page=1&pageSize=10&status=enabled&sortBy=created_at&sortOrder=desc
```

**响应格式**:

```json
{
  "success": true,
  "message": "操作成功",
  "data": {
    "total": 50,
    "page": 1,
    "pageSize": 10,
    "list": [
      {
        "id": 1,
        "name": "学费",
        "code": "TUITION",
        "description": "学期学费",
        "defaultAmount": 5000.00,
        "billingCycle": "semester",
        "allocationRule": "average",
        "usageCount": 1250,
        "sortOrder": 1,
        "status": "enabled",
        "createTime": "2024-01-15T10:30:00Z",
        "updateTime": "2024-01-15T10:30:00Z"
      }
    ]
  }
}
```

**业务逻辑**：

1. 支持多条件组合搜索
2. usageCount 实时统计：`SELECT COUNT(*) FROM expenses WHERE category_id = :id`
3. 自动映射数据库字段到前端字段
4. 分页参数校验和边界处理

**错误处理**：

* 400: 参数错误（page < 1, pageSize 超出范围等）

* 500: 服务器内部错误

***

#### 接口2：获取费用类型详情

**请求信息**：

* **方法**: GET

* **URL**: `/api/fee-types/:id`

**请求参数** (Path Parameters):

| 参数名 | 类型     | 必填 | 说明     |
| --- | ------ | -- | ------ |
| id  | number | 是  | 费用类型ID |

**请求示例**:

```
GET /api/fee-types/1
```

**响应格式**:

```json
{
  "success": true,
  "message": "操作成功",
  "data": {
    "id": 1,
    "name": "学费",
    "code": "TUITION",
    "description": "学期学费",
    "defaultAmount": 5000.00,
    "billingCycle": "semester",
    "allocationRule": "average",
    "usageCount": 1250,
    "sortOrder": 1,
    "status": "enabled",
    "createTime": "2024-01-15T10:30:00Z",
    "updateTime": "2024-01-15T10:30:00Z"
  }
}
```

**业务逻辑**：

1. 实时统计 usageCount
2. 返回完整字段信息

**错误处理**：

* 404: 费用类型不存在

* 500: 服务器内部错误

***

#### 接口3：新增费用类型

**请求信息**：

* **方法**: POST

* **URL**: `/api/fee-types`

* **Content-Type**: application/json

**请求体**:

| 字段名            | 类型     | 必填 | 说明               |
| -------------- | ------ | -- | ---------------- |
| name           | string | 是  | 名称，最大100字符       |
| code           | string | 是  | 编码，最大50字符，唯一     |
| description    | string | 否  | 描述               |
| defaultAmount  | number | 否  | 默认金额             |
| billingCycle   | string | 否  | 计费周期，默认 one-time |
| allocationRule | string | 否  | 分摊规则，默认 none     |
| sortOrder      | number | 否  | 排序序号，默认0         |

**请求示例**:

```json
{
  "name": "住宿费",
  "code": "DORMITORY",
  "description": "宿舍住宿费用",
  "defaultAmount": 1200.00,
  "billingCycle": "monthly",
  "allocationRule": "dormitory",
  "sortOrder": 2
}
```

**响应格式**:

```json
{
  "success": true,
  "message": "创建成功",
  "data": {
    "id": 2,
    "name": "住宿费",
    "code": "DORMITORY",
    "description": "宿舍住宿费用",
    "defaultAmount": 1200.00,
    "billingCycle": "monthly",
    "allocationRule": "dormitory",
    "usageCount": 0,
    "sortOrder": 2,
    "status": "enabled",
    "createTime": "2024-01-20T14:30:00Z",
    "updateTime": "2024-01-20T14:30:00Z"
  }
}
```

**业务逻辑**：

1. 校验必填字段
2. 校验 code 唯一性（数据库约束）
3. 校验 billingCycle 枚举值合法性
4. 校验 allocationRule 枚举值合法性
5. 默认为 enabled 状态

**错误处理**：

* 400: 参数校验失败（必填字段为空、枚举值不合法等）

* 409: code 已存在（唯一性冲突）

* 500: 服务器内部错误

***

#### 接口4：编辑费用类型

**请求信息**：

* **方法**: PUT

* **URL**: `/api/fee-types/:id`

* **Content-Type**: application/json

**请求参数** (Path Parameters):

| 参数名 | 类型     | 必填 | 说明     |
| --- | ------ | -- | ------ |
| id  | number | 是  | 费用类型ID |

**请求体** (所有字段均为可选):

| 字段名            | 类型     | 说明   |
| -------------- | ------ | ---- |
| name           | string | 名称   |
| description    | string | 描述   |
| defaultAmount  | number | 默认金额 |
| billingCycle   | string | 计费周期 |
| allocationRule | string | 分摊规则 |
| sortOrder      | number | 排序序号 |

**请求示例**:

```json
{
  "name": "住宿费（更新）",
  "defaultAmount": 1500.00
}
```

**响应格式**:

```json
{
  "success": true,
  "message": "更新成功",
  "data": {
    "id": 2,
    "name": "住宿费（更新）",
    "code": "DORMITORY",
    "description": "宿舍住宿费用",
    "defaultAmount": 1500.00,
    "billingCycle": "monthly",
    "allocationRule": "dormitory",
    "usageCount": 0,
    "sortOrder": 2,
    "status": "enabled",
    "createTime": "2024-01-20T14:30:00Z",
    "updateTime": "2024-01-20T15:00:00Z"
  }
}
```

**业务逻辑**：

1. 校验费用类型存在性
2. 校验 billingCycle 枚举值合法性（如果提供）
3. 校验 allocationRule 枚举值合法性（如果提供）
4. 更新时间自动更新

**错误处理**：

* 400: 参数校验失败

* 404: 费用类型不存在

* 500: 服务器内部错误

***

#### 接口5：删除费用类型

**请求信息**：

* **方法**: DELETE

* **URL**: `/api/fee-types/:id`

**请求参数** (Path Parameters):

| 参数名 | 类型     | 必填 | 说明     |
| --- | ------ | -- | ------ |
| id  | number | 是  | 费用类型ID |

**响应格式** (成功):

```json
{
  "success": true,
  "message": "删除成功",
  "data": null
}
```

**响应格式** (失败 - 被引用时):

```json
{
  "success": false,
  "message": "该费用类型已被费用记录引用，无法删除",
  "data": null,
  "errorCode": "FEE_TYPE_IN_USE"
}
```

**业务逻辑**：

1. 检查费用类型是否存在
2. 检查是否有费用记录引用该类型
3. 执行删除操作
4. 返回操作结果

**错误处理**：

* 404: 费用类型不存在

* 409: 费用类型被引用（FOREIGN KEY 约束或业务检查）

* 500: 服务器内部错误

***

#### 接口6：更新状态

**请求信息**：

* **方法**: PUT

* **URL**: `/api/fee-types/:id/status`

* **Content-Type**: application/json

**请求参数** (Path Parameters):

| 参数名 | 类型     | 必填 | 说明     |
| --- | ------ | -- | ------ |
| id  | number | 是  | 费用类型ID |

**请求体**:

| 字段名    | 类型     | 必填 | 说明                   |
| ------ | ------ | -- | -------------------- |
| status | string | 是  | 状态: enabled/disabled |

**请求示例**:

```json
{
  "status": "disabled"
}
```

**响应格式**:

```json
{
  "success": true,
  "message": "状态更新成功",
  "data": {
    "id": 2,
    "status": "disabled"
  }
}
```

**业务逻辑**：

1. 校验费用类型存在性
2. 校验 status 枚举值合法性
3. 更新状态

**错误处理**：

* 400: status 值不合法

* 404: 费用类型不存在

* 500: 服务器内部错误

***

#### 接口7：导入费用类型

**请求信息**：

* **方法**: POST

* **URL**: `/api/fee-types/import`

* **Content-Type**: multipart/form-data

**请求参数** (Form Data):

| 字段名       | 类型      | 必填 | 说明                    |
| --------- | ------- | -- | --------------------- |
| file      | File    | 是  | Excel文件 (.xlsx, .xls) |
| overwrite | boolean | 否  | 是否覆盖已存在的编码，默认false    |

**响应格式**:

```json
{
  "success": true,
  "message": "导入成功",
  "data": {
    "total": 10,
    "success": 10,
    "failed": 0,
    "errors": []
  }
}
```

**响应格式** (部分失败):

```json
{
  "success": true,
  "message": "导入完成，部分数据失败",
  "data": {
    "total": 10,
    "success": 8,
    "failed": 2,
    "errors": [
      {
        "row": 3,
        "message": "编码 'TUITION' 已存在"
      },
      {
        "row": 5,
        "message": "计费周期 'invalid' 不合法"
      }
    ]
  }
}
```

**Excel模板格式**：

| 名称  | 编码        | 描述   | 默认金额 | 计费周期     | 分摊规则      | 排序 |
| --- | --------- | ---- | ---- | -------- | --------- | -- |
| 学费  | TUITION   | 学期学费 | 5000 | semester | average   | 1  |
| 住宿费 | DORMITORY | 宿舍费用 | 1200 | monthly  | dormitory | 2  |

**业务逻辑**：

1. 解析Excel文件
2. 逐行校验数据
3. 批量插入/更新数据库
4. 返回导入统计和错误详情

**错误处理**：

* 400: 文件格式错误、模板不匹配

* 500: 服务器内部错误

***

#### 接口8：导出费用类型

**请求信息**：

* **方法**: GET

* **URL**: `/api/fee-types/export`

**请求参数** (Query Parameters):

| 参数名    | 类型     | 必填 | 说明                     |
| ------ | ------ | -- | ---------------------- |
| status | string | 否  | 状态筛选: enabled/disabled |
| search | string | 否  | 搜索关键词                  |

**响应格式**:

* **Content-Type**: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet

* **Content-Disposition**: attachment; filename="fee-types\_20240120.xlsx"

**业务逻辑**：

1. 根据条件查询数据
2. 生成Excel文件
3. 返回文件流

**错误处理**：

* 500: 生成Excel失败

***

## 三、数据字段映射

### 3.1 数据库字段 → 前端字段

| 数据库字段            | 前端字段           | 数据类型转换                              |
| ---------------- | -------------- | ----------------------------------- |
| id               | id             | 直接返回                                |
| category\_name   | name           | 直接返回                                |
| category\_code   | code           | 直接返回                                |
| description      | description    | 直接返回                                |
| default\_amount  | defaultAmount  | snake\_case → camelCase             |
| billing\_cycle   | billingCycle   | 直接返回                                |
| allocation\_rule | allocationRule | 直接返回                                |
| COUNT(e.id)      | usageCount     | 子查询统计                               |
| sort\_order      | sortOrder      | snake\_case → camelCase             |
| is\_active       | status         | boolean → string (enabled/disabled) |
| created\_at      | createTime     | TIMESTAMP → ISO 8601                |
| updated\_at      | updateTime     | TIMESTAMP → ISO 8601                |

### 3.2 枚举值映射

**billingCycle** 枚举：

* 数据库存储: one-time, monthly, semester, yearly

* 前端展示: 一次性、每月、每学期、每年

**allocationRule** 枚举：

* 数据库存储: average, dormitory, none

* 前端展示: 平均分摊、按宿舍分摊、不分摊

**status** 枚举：

* 数据库存储: true/false

* 前端展示: enabled/disabled

***

## 四、错误码定义

| 错误码                       | HTTP状态码 | 说明       |
| ------------------------- | ------- | -------- |
| FEE\_TYPE\_NOT\_FOUND     | 404     | 费用类型不存在  |
| FEE\_TYPE\_CODE\_EXISTS   | 409     | 编码已存在    |
| FEE\_TYPE\_IN\_USE        | 409     | 费用类型被引用  |
| INVALID\_BILLING\_CYCLE   | 400     | 计费周期值不合法 |
| INVALID\_ALLOCATION\_RULE | 400     | 分摊规则值不合法 |
| INVALID\_STATUS           | 400     | 状态值不合法   |
| INVALID\_PARAMS           | 400     | 参数错误     |
| IMPORT\_ERROR             | 400     | 导入错误     |
| SERVER\_ERROR             | 500     | 服务器内部错误  |

***

## 五、实现优先级

**第一阶段**（核心功能）：

1. 获取费用类型列表
2. 获取费用类型详情
3. 新增费用类型
4. 编辑费用类型
5. 删除费用类型
6. 更新状态

**第二阶段**（增强功能）：
7\. 导入费用类型
8\. 导出费用类型

***

## 六、测试验证计划

1. **单元测试**：各接口参数校验、边界条件
2. **集成测试**：数据库操作、事务处理
3. **业务逻辑测试**：usageCount统计、状态切换规则
4. **异常测试**：错误码返回、异常处理

