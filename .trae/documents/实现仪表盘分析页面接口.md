# 统计分析页面接口实现计划

## 1. 需求分析

`/dashboard/analytics` 页面（统计分析）需要以下数据：
- 统计概览卡片：总支出、预算余额、支出趋势、活跃用户
- 功能模块导航：支出统计、趋势分析、预算管理

## 2. 数据库表格检查结果

### 2.1 关键表格存在情况
✅ 所有需要的关键表格均已存在：
- `expenses`：费用记录表
- `expense_categories`：费用类别表
- `expense_splits`：费用分摊表
- `dorms`：宿舍表
- `user_dorms`：用户宿舍关联表
- `users`：用户表
- `budgets`：预算表
- `budget_categories`：预算类别表
- `budget_usage_records`：预算使用记录表
- `budget_alerts`：预算预警表

### 2.2 表格结构完整性
✅ `expenses` 表格结构完整，包含所有必要字段：
- id：主键
- title：费用标题
- amount：金额
- category_id：类别ID
- expense_date：费用发生日期
- status：状态
- applicant_id：申请人ID
- dorm_id：宿舍ID
- payer_id：支付人ID
- split_type：分摊类型
- split_details：分摊详情
- created_at：创建时间
- updated_at：更新时间

## 3. 接口实现计划

### 3.1 统计概览接口

**路径**：`/api/dashboard/statistics`
**方法**：GET
**功能**：获取统计概览卡片数据，包括：
- 总支出（本月）
- 预算余额
- 支出趋势（相比上月）
- 活跃用户（本月）

### 3.2 支出统计详细接口

**路径**：`/api/expenses/statistics`
**方法**：GET
**功能**：获取支出统计数据，包括：
- 支出总览（总金额、日均支出、分类数、单笔最高）
- 支出趋势数据
- 分类占比数据
- 成员支出对比数据
- 时段支出分布数据
- 支出明细数据

### 3.3 趋势分析接口

**路径**：`/api/trend/analysis`
**方法**：GET
**功能**：获取趋势分析数据，包括：
- 支出/收入/结余趋势数据
- 同比/环比对比数据
- 异常检测结果
- 趋势预测数据

### 3.4 预算管理接口

**路径**：`/api/budget/statistics`
**方法**：GET
**功能**：获取预算相关数据，包括：
- 预算总额和使用情况
- 预算分类分布
- 预算使用趋势
- 预算预警信息

## 4. 实现步骤

1. 检查现有 `/api/dashboard/statistics` 接口，确认是否需要扩展
2. 实现支出统计详细接口 `/api/expenses/statistics`
3. 实现趋势分析接口 `/api/trend/analysis`
4. 实现预算管理接口 `/api/budget/statistics`
5. 测试接口功能
6. 确保前端组件正确调用接口

## 5. 关键技术点

- 使用 PostgreSQL 聚合函数进行统计计算
- 实现时间范围筛选功能
- 支持不同时间粒度（日/周/月）
- 实现异常检测算法
- 实现简单的趋势预测功能

## 6. 数据结构设计

### 6.1 统计概览接口响应结构

```json
{
  "success": true,
  "data": {
    "totalExpense": 1250.50,          // 本月总支出
    "budgetBalance": 1749.50,         // 预算余额
    "expenseTrend": 10.5,             // 相比上月变化率(%)
    "activeUsers": 4                  // 本月活跃用户数
  }
}
```

### 6.2 支出统计接口响应结构

```json
{
  "success": true,
  "data": {
    "statistics": {
      "totalExpense": 1250.50,        // 总支出
      "dailyAverage": 41.68,          // 日均支出
      "categoryCount": 5,             // 支出类别数
      "maxExpense": 500.00,           // 单笔最高支出
      "maxExpenseCategory": "房租"   // 最高支出类别
    },
    "trendData": [                    // 支出趋势数据
      { "date": "2025-12-01", "amount": 80.00 },
      { "date": "2025-12-02", "amount": 120.00 },
      // ...
    ],
    "categoryData": [                 // 分类占比数据
      { "name": "房租", "value": 500.00, "percentage": 40 },
      { "name": "水电费", "value": 300.00, "percentage": 24 },
      // ...
    ],
    "memberData": [                   // 成员支出对比数据
      { "name": "张三", "amount": 450.00 },
      { "name": "李四", "amount": 380.00 },
      // ...
    ],
    "timeData": [                     // 时段支出分布数据
      { "period": "00:00-06:00", "amount": 50.00 },
      { "period": "06:00-12:00", "amount": 450.00 },
      // ...
    ],
    "detailData": [                   // 支出明细数据
      {
        "id": 1,
        "date": "2025-12-01",
        "category": "房租",
        "description": "12月份房租",
        "amount": 500.00,
        "payer": "张三",
        "status": "approved"
      },
      // ...
    ],
    "total": 20                       // 总记录数
  }
}
```

### 6.3 趋势分析接口响应结构

```json
{
  "success": true,
  "data": {
    "trendData": [                    // 趋势数据
      { "date": "2025-11-01", "expense": 1100.00, "income": 0.00, "balance": -1100.00 },
      { "date": "2025-12-01", "expense": 1250.50, "income": 0.00, "balance": -1250.50 },
      // ...
    ],
    "comparisonData": [               // 对比数据
      { "period": "2025-11", "current": 1250.50, "comparison": 1100.00, "change": 13.68 },
      // ...
    ],
    "anomalies": [                    // 异常检测结果
      {
        "date": "2025-12-15",
        "value": 800.00,
        "deviation": 2.5,
        "reason": "超出正常支出范围"
      },
      // ...
    ],
    "prediction": [                   // 预测数据
      { "date": "2026-01-01", "value": 1300.00, "confidence": 85 },
      { "date": "2026-02-01", "value": 1350.00, "confidence": 80 },
      // ...
    ]
  }
}
```

### 6.4 预算管理接口响应结构

```json
{
  "success": true,
  "data": {
    "totalBudget": 3000.00,           // 预算总额
    "usedBudget": 1250.50,            // 已使用预算
    "remainingBudget": 1749.50,       // 剩余预算
    "usagePercentage": 41.68,         // 预算使用率(%)
    "budgetCategories": [             // 预算分类分布
      { "name": "房租", "budget": 1500.00, "used": 500.00, "percentage": 33.33 },
      { "name": "水电费", "budget": 600.00, "used": 300.00, "percentage": 50.00 },
      // ...
    ],
    "budgetTrend": [                  // 预算使用趋势
      { "date": "2025-12-01", "used": 0.00 },
      { "date": "2025-12-10", "used": 600.00 },
      { "date": "2025-12-20", "used": 1100.00 },
      { "date": "2025-12-31", "used": 1250.50 },
    ],
    "alerts": [                       // 预算预警信息
      {
        "id": 1,
        "category": "水电费",
        "threshold": 80,
        "currentUsage": 50.00,
        "status": "warning",
        "message": "水电费预算使用已达50%"
      },
      // ...
    ]
  }
}
```

## 7. 实现顺序

1. 检查并扩展现有 `/api/dashboard/statistics` 接口，确保提供统计概览数据
2. 实现支出统计接口 `/api/expenses/statistics`
3. 实现趋势分析接口 `/api/trend/analysis`
4. 实现预算管理接口 `/api/budget/statistics`
5. 测试所有接口功能
6. 确保前端组件正确调用接口

## 8. 测试计划

1. 分别测试每个接口的基本功能
2. 测试不同时间范围的筛选功能
3. 测试不同时间粒度的数据展示
4. 测试异常检测功能
5. 测试预测功能
6. 确保所有接口都返回正确的数据结构

## 9. 优化考虑

- 实现接口缓存，提高性能
- 优化数据库查询，使用索引提高查询速度
- 实现数据分页，减少单次返回的数据量
- 支持数据导出功能

## 10. 风险评估

- 数据量过大时可能影响查询性能，需要考虑分页和缓存
- 异常检测和预测算法可能需要调整参数以提高准确性
- 不同时间粒度的数据计算可能存在复杂度差异

## 11. 依赖关系

- 依赖数据库中存在相关的费用、预算、成员等数据
- 依赖后端框架和数据库连接
- 前端需要正确调用这些接口并处理数据

## 12. 交付标准

- 所有接口实现完成并通过测试
- 接口文档完善
- 前端能够正确调用接口并展示数据
- 代码质量符合项目标准

## 13. 后续维护

- 定期检查接口性能
- 根据业务需求调整统计逻辑
- 优化异常检测和预测算法
- 更新接口文档