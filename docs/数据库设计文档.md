# è®°è´¦ç³»ç»Ÿæ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ðŸ“‹ æ–‡æ¡£è¯´æ˜Ž
æœ¬æ–‡æ¡£å®šä¹‰äº†è®°è´¦ç³»ç»Ÿçš„å®Œæ•´æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬è¡¨ç»“æž„ã€ç´¢å¼•ã€çº¦æŸã€å…³ç³»è®¾è®¡ç­‰ã€‚é‡‡ç”¨PostgreSQLæ•°æ®åº“ï¼Œæ”¯æŒJSONç±»åž‹å’Œäº‹åŠ¡å¤„ç†ã€‚

## ðŸ“– ç›®å½•

### 1. æ•°æ®åº“è®¾è®¡åŽŸåˆ™
1.1 è®¾è®¡è§„èŒƒ
1.2 å‘½åçº¦å®š
1.3 æ•°æ®ç±»åž‹è§„èŒƒ
1.4 çº¦æŸè®¾è®¡

### 2. ç”¨æˆ·ç®¡ç†æ¨¡å—
2.1 ç”¨æˆ·è¡¨ (users)
2.2 è§’è‰²è¡¨ (roles)
2.3 æƒé™è¡¨ (permissions)
2.4 ç”¨æˆ·è§’è‰²å…³è”è¡¨ (user_roles)

### 3. å¯å®¤ç®¡ç†æ¨¡å—
3.1 å¯å®¤è¡¨ (rooms)
3.2 å¯å®¤æˆå‘˜å…³ç³»è¡¨ (room_members)
3.3 é‚€è¯·ç è¡¨ (invitation_codes)

### 4. è´¹ç”¨ç®¡ç†æ¨¡å—
4.1 è´¹ç”¨ç±»åž‹è¡¨ (expense_types)
4.2 è´¹ç”¨è®°å½•è¡¨ (expenses)
4.3 è´¹ç”¨åˆ†æ‘Šè¡¨ (expense_splits)
4.4 è´¹ç”¨å®¡æ ¸è¡¨ (expense_reviews)

### 5. æ”¯ä»˜ç®¡ç†æ¨¡å—
5.1 æ”¶æ¬¾ç è¡¨ (payment_codes)
5.2 æ”¯ä»˜è®°å½•è¡¨ (payments)
5.3 è´¦å•è¡¨ (bills)
5.4 è´¦å•æ˜Žç»†è¡¨ (bill_items)

### 6. ç³»ç»Ÿç®¡ç†æ¨¡å—
6.1 ç³»ç»Ÿé…ç½®è¡¨ (system_configs)
6.2 é€šçŸ¥è¡¨ (notifications)
6.3 æ“ä½œæ—¥å¿—è¡¨ (audit_logs)

### 7. ç´¢å¼•ä¸Žæ€§èƒ½ä¼˜åŒ–
7.1 ä¸»è¦ç´¢å¼•è®¾è®¡
7.2 æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
7.3 åˆ†åŒºç­–ç•¥

### 8. æ•°æ®å®‰å…¨ä¸Žå¤‡ä»½
8.1 æ•°æ®åŠ å¯†
8.2 å¤‡ä»½ç­–ç•¥
8.3 æ•°æ®æ¸…ç†

---

## 1. æ•°æ®åº“è®¾è®¡åŽŸåˆ™

### 1.1 è®¾è®¡è§„èŒƒ
- **ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰**ï¼šç¡®ä¿æ•°æ®æ— å†—ä½™ï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§
- **å¯æ‰©å±•æ€§**ï¼šè€ƒè™‘ä¸šåŠ¡å¢žé•¿ï¼Œé¢„ç•™æ‰©å±•ç©ºé—´
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†è®¾è®¡ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- **æ•°æ®å®Œæ•´æ€§**ï¼šé€šè¿‡çº¦æŸä¿è¯æ•°æ®è´¨é‡

### 1.2 å‘½åçº¦å®š
- **è¡¨å**ï¼šä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼ˆsnake_caseï¼‰
- **å­—æ®µå**ï¼šä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
- **ä¸»é”®**ï¼šç»Ÿä¸€å‘½åä¸º `id`
- **å¤–é”®**ï¼šä½¿ç”¨ `{table_name}_id` æ ¼å¼
- **æ—¶é—´å­—æ®µ**ï¼šä½¿ç”¨ `created_at`ã€`updated_at`ã€`deleted_at`

### 1.3 æ•°æ®ç±»åž‹è§„èŒƒ
- **ä¸»é”®**ï¼šä½¿ç”¨ `BIGSERIAL` æˆ– `UUID`
- **é‡‘é¢**ï¼šä½¿ç”¨ `DECIMAL(10,2)`ï¼Œç¡®ä¿ç²¾åº¦
- **æ—¶é—´**ï¼šä½¿ç”¨ `TIMESTAMP WITH TIME ZONE`
- **æ–‡æœ¬**ï¼šçŸ­æ–‡æœ¬ä½¿ç”¨ `VARCHAR`ï¼Œé•¿æ–‡æœ¬ä½¿ç”¨ `TEXT`
- **JSONæ•°æ®**ï¼šä½¿ç”¨ `JSONB` ç±»åž‹

### 1.4 çº¦æŸè®¾è®¡
- **ä¸»é”®çº¦æŸ**ï¼šæ¯ä¸ªè¡¨å¿…é¡»æœ‰ä¸»é”®
- **å¤–é”®çº¦æŸ**ï¼šä¿è¯å‚ç…§å®Œæ•´æ€§
- **å”¯ä¸€çº¦æŸ**ï¼šç¡®ä¿å…³é”®å­—æ®µå”¯ä¸€æ€§
- **æ£€æŸ¥çº¦æŸ**ï¼šä¿è¯ä¸šåŠ¡è§„åˆ™æ­£ç¡®æ€§

---

## 2. ç”¨æˆ·ç®¡ç†æ¨¡å—

### 2.1 ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    username VARCHAR(50) NOT NULL UNIQUE,
    phone VARCHAR(20),
    password_hash VARCHAR(255) NOT NULL,
    avatar_url TEXT,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'suspended')),
    email_verified BOOLEAN DEFAULT FALSE,
    phone_verified BOOLEAN DEFAULT FALSE,
    last_login_at TIMESTAMP WITH TIME ZONE,
    last_login_ip INET,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE
);

-- ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_deleted_at ON users(deleted_at) WHERE deleted_at IS NULL;
```

### 2.2 è§’è‰²è¡¨ (roles)
```sql
CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    role_name VARCHAR(50) NOT NULL UNIQUE,
    role_display_name VARCHAR(100) NOT NULL,
    description TEXT,
    is_system BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- é¢„ç½®è§’è‰²æ•°æ®
INSERT INTO roles (role_name, role_display_name, description, is_system) VALUES
('system_admin', 'ç³»ç»Ÿç®¡ç†å‘˜', 'ç³»ç»Ÿæœ€é«˜æƒé™ç®¡ç†å‘˜', TRUE),
('admin', 'ç®¡ç†å‘˜', 'ç³»ç»Ÿè¿è¥ç®¡ç†å‘˜', TRUE),
('room_leader', 'å¯å®¤é•¿', 'å¯å®¤è´Ÿè´£äºº', TRUE),
('payment_collector', 'ç¼´è´¹äºº', 'è´Ÿè´£è´¹ç”¨æ”¶ç¼´çš„æˆå‘˜', TRUE),
('normal_user', 'æ™®é€šç”¨æˆ·', 'æ™®é€šå¯å®¤æˆå‘˜', TRUE);
```

### 2.3 æƒé™è¡¨ (permissions)
```sql
CREATE TABLE permissions (
    id SERIAL PRIMARY KEY,
    permission_name VARCHAR(100) NOT NULL UNIQUE,
    permission_display_name VARCHAR(100) NOT NULL,
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- æƒé™ç¤ºä¾‹æ•°æ®
INSERT INTO permissions (permission_name, permission_display_name, resource, action, description) VALUES
('users.view', 'æŸ¥çœ‹ç”¨æˆ·', 'users', 'view', 'æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯'),
('users.create', 'åˆ›å»ºç”¨æˆ·', 'users', 'create', 'åˆ›å»ºæ–°ç”¨æˆ·'),
('users.update', 'æ›´æ–°ç”¨æˆ·', 'users', 'update', 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯'),
('rooms.view', 'æŸ¥çœ‹å¯å®¤', 'rooms', 'view', 'æŸ¥çœ‹å¯å®¤ä¿¡æ¯'),
('rooms.create', 'åˆ›å»ºå¯å®¤', 'rooms', 'create', 'åˆ›å»ºæ–°å¯å®¤'),
('rooms.update', 'æ›´æ–°å¯å®¤', 'rooms', 'update', 'æ›´æ–°å¯å®¤ä¿¡æ¯'),
('expenses.view', 'æŸ¥çœ‹è´¹ç”¨', 'expenses', 'view', 'æŸ¥çœ‹è´¹ç”¨è®°å½•'),
('expenses.create', 'åˆ›å»ºè´¹ç”¨', 'expenses', 'create', 'åˆ›å»ºè´¹ç”¨è®°å½•'),
('expenses.update', 'æ›´æ–°è´¹ç”¨', 'expenses', 'update', 'æ›´æ–°è´¹ç”¨è®°å½•'),
('expenses.delete', 'åˆ é™¤è´¹ç”¨', 'expenses', 'delete', 'åˆ é™¤è´¹ç”¨è®°å½•'),
('expenses.review', 'å®¡æ ¸è´¹ç”¨', 'expenses', 'review', 'å®¡æ ¸è´¹ç”¨è®°å½•');
```

### 2.4 ç”¨æˆ·è§’è‰²å…³è”è¡¨ (user_roles)
```sql
CREATE TABLE user_roles (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role_id INTEGER NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
    room_id BIGINT, -- å…³è”å¯å®¤ï¼Œç”¨äºŽè§’è‰²é™å®šèŒƒå›´
    assigned_by BIGINT REFERENCES users(id),
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE,
    
    UNIQUE(user_id, role_id, room_id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
CREATE INDEX idx_user_roles_room_id ON user_roles(room_id);
```

---

## 3. å¯å®¤ç®¡ç†æ¨¡å—

### 3.1 å¯å®¤è¡¨ (rooms)
```sql
CREATE TABLE rooms (
    id BIGSERIAL PRIMARY KEY,
    room_name VARCHAR(100) NOT NULL,
    room_number VARCHAR(20) NOT NULL,
    building VARCHAR(50) NOT NULL,
    floor INTEGER NOT NULL,
    capacity INTEGER NOT NULL CHECK (capacity > 0),
    description TEXT,
    leader_id BIGINT NOT NULL REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'maintenance')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE
);

-- ç´¢å¼•
CREATE INDEX idx_rooms_leader_id ON rooms(leader_id);
CREATE INDEX idx_rooms_building ON rooms(building);
CREATE INDEX idx_rooms_status ON rooms(status);
CREATE INDEX idx_rooms_deleted_at ON rooms(deleted_at) WHERE deleted_at IS NULL;

-- ç¡®ä¿åŒä¸€æ ‹æ¥¼æ¥¼å·å”¯ä¸€
CREATE UNIQUE INDEX idx_rooms_building_room_number ON rooms(building, room_number) WHERE deleted_at IS NULL;
```

### 3.2 å¯å®¤æˆå‘˜å…³ç³»è¡¨ (room_members)
```sql
CREATE TABLE room_members (
    id BIGSERIAL PRIMARY KEY,
    room_id BIGINT NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(20) DEFAULT 'normal_user' CHECK (role IN ('leader', 'payment_collector', 'normal_user')),
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'pending')),
    joined_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    left_at TIMESTAMP WITH TIME ZONE,
    moved_in_date DATE DEFAULT CURRENT_DATE,
    moved_out_date DATE,
    notes TEXT,
    
    UNIQUE(room_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_room_members_room_id ON room_members(room_id);
CREATE INDEX idx_room_members_user_id ON room_members(user_id);
CREATE INDEX idx_room_members_status ON room_members(status);
CREATE INDEX idx_room_members_joined_at ON room_members(joined_at);

-- æ£€æŸ¥çº¦æŸï¼šæ´»è·ƒæˆå‘˜ä¸èƒ½æœ‰ç¦»å¼€æ—¥æœŸ
ALTER TABLE room_members ADD CONSTRAINT chk_active_member_dates 
CHECK (
    (status = 'active' AND left_at IS NULL AND moved_out_date IS NULL) OR
    (status != 'active' AND (left_at IS NOT NULL OR moved_out_date IS NOT NULL))
);
```

### 3.3 é‚€è¯·ç è¡¨ (invitation_codes)
```sql
CREATE TABLE invitation_codes (
    id BIGSERIAL PRIMARY KEY,
    room_id BIGINT NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
    code VARCHAR(4) NOT NULL,
    max_uses INTEGER DEFAULT 1 CHECK (max_uses > 0),
    used_count INTEGER DEFAULT 0 CHECK (used_count >= 0),
    expires_at TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT TRUE,
    created_by BIGINT NOT NULL REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_uses_limit CHECK (used_count <= max_uses),
    CONSTRAINT chk_expires_at CHECK (expires_at IS NULL OR expires_at > CURRENT_TIMESTAMP)
);

-- ç´¢å¼•
CREATE INDEX idx_invitation_codes_room_id ON invitation_codes(room_id);
CREATE INDEX idx_invitation_codes_code ON invitation_codes(code);
CREATE INDEX idx_invitation_codes_active ON invitation_codes(is_active, expires_at) WHERE is_active = TRUE;

-- ç¡®ä¿é‚€è¯·ç åœ¨åŒå¯å®¤å†…å”¯ä¸€
CREATE UNIQUE INDEX idx_invitation_codes_room_code ON invitation_codes(room_id, code) WHERE is_active = TRUE;
```

---

## 4. è´¹ç”¨ç®¡ç†æ¨¡å—

### 4.1 è´¹ç”¨ç±»åž‹è¡¨ (expense_types)
```sql
CREATE TABLE expense_types (
    id SERIAL PRIMARY KEY,
    type_name VARCHAR(50) NOT NULL UNIQUE,
    type_display_name VARCHAR(100) NOT NULL,
    description TEXT,
    category VARCHAR(50), -- utilities, maintenance, supplies, etc.
    color_code VARCHAR(7), -- Hex color code for UI display
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- è´¹ç”¨ç±»åž‹ç¤ºä¾‹æ•°æ®
INSERT INTO expense_types (type_name, type_display_name, description, category, color_code, sort_order) VALUES
('utilities', 'æ°´ç”µè´¹', 'æ°´ç”µç‡ƒæ°”ç­‰å…¬ç”¨äº‹ä¸šè´¹ç”¨', 'utilities', '#3B82F6', 1),
('maintenance', 'ç»´ä¿®è´¹', 'è®¾å¤‡ç»´ä¿®å’Œä¿å…»è´¹ç”¨', 'maintenance', '#10B981', 2),
('supplies', 'ç”Ÿæ´»ç”¨å“', 'å¯å®¤å…¬å…±ç”Ÿæ´»ç”¨å“', 'supplies', '#F59E0B', 3),
('internet', 'ç½‘ç»œè´¹', 'å®½å¸¦å’Œç½‘ç»œç›¸å…³è´¹ç”¨', 'utilities', '#8B5CF6', 4),
('cleaning', 'æ¸…æ´è´¹', 'æ¸…æ´ç”¨å“å’Œæ¸…æ´æœåŠ¡è´¹ç”¨', 'supplies', '#06B6D4', 5);

-- ç´¢å¼•
CREATE INDEX idx_expense_types_category ON expense_types(category);
CREATE INDEX idx_expense_types_active ON expense_types(is_active);
CREATE INDEX idx_expense_types_sort_order ON expense_types(sort_order);
```

### 4.2 è´¹ç”¨è®°å½•è¡¨ (expenses)
```sql
CREATE TABLE expenses (
    id BIGSERIAL PRIMARY KEY,
    room_id BIGINT NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    amount DECIMAL(10,2) NOT NULL CHECK (amount >= 0),
    expense_type_id INTEGER NOT NULL REFERENCES expense_types(id),
    expense_date DATE NOT NULL,
    due_date DATE,
    billing_period_start DATE,
    billing_period_end DATE,
    created_by BIGINT NOT NULL REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'pending_review' CHECK (status IN ('pending_review', 'approved', 'rejected', 'cancelled')),
    receipt_url TEXT, -- ç¥¨æ®å›¾ç‰‡URL
    receipt_data JSONB, -- ç¥¨æ®è¯¦ç»†ä¿¡æ¯
    calculation_method VARCHAR(20) DEFAULT 'basic' CHECK (calculation_method IN ('basic', 'smart', 'custom')),
    calculation_params JSONB, -- åˆ†æ‘Šè®¡ç®—å‚æ•°
    total_split_amount DECIMAL(10,2), -- åˆ†æ‘ŠåŽæ€»é‡‘é¢ï¼ˆç”¨äºŽéªŒè¯ï¼‰
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP WITH TIME ZONE
);

-- ç´¢å¼•
CREATE INDEX idx_expenses_room_id ON expenses(room_id);
CREATE INDEX idx_expenses_type_id ON expenses(expense_type_id);
CREATE INDEX idx_expenses_created_by ON expenses(created_by);
CREATE INDEX idx_expenses_status ON expenses(status);
CREATE INDEX idx_expenses_expense_date ON expenses(expense_date);
CREATE INDEX idx_expenses_due_date ON expenses(due_date);
CREATE INDEX idx_expenses_deleted_at ON expenses(deleted_at) WHERE deleted_at IS NULL;

-- æ£€æŸ¥çº¦æŸï¼šåˆ†æ‘Šæ€»é‡‘é¢åº”è¯¥ç­‰äºŽè´¹ç”¨æ€»é¢
ALTER TABLE expenses ADD CONSTRAINT chk_split_amount 
CHECK (total_split_amount IS NULL OR total_split_amount = amount);
```

### 4.3 è´¹ç”¨åˆ†æ‘Šè¡¨ (expense_splits)
```sql
CREATE TABLE expense_splits (
    id BIGSERIAL PRIMARY KEY,
    expense_id BIGINT NOT NULL REFERENCES expenses(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id),
    amount DECIMAL(10,2) NOT NULL CHECK (amount >= 0),
    percentage DECIMAL(5,2) CHECK (percentage >= 0 AND percentage <= 100),
    calculation_basis JSONB, -- è®¡ç®—ä¾æ®è¯¦ç»†ä¿¡æ¯
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'exempted')),
    payment_status VARCHAR(20) DEFAULT 'unpaid' CHECK (payment_status IN ('unpaid', 'paid', 'overdue')),
    paid_at TIMESTAMP WITH TIME ZONE,
    payment_method VARCHAR(20), -- wechat, alipay, cash
    payment_reference VARCHAR(100), -- æ”¯ä»˜å‚è€ƒå·
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(expense_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_expense_splits_expense_id ON expense_splits(expense_id);
CREATE INDEX idx_expense_splits_user_id ON expense_splits(user_id);
CREATE INDEX idx_expense_splits_status ON expense_splits(status);
CREATE INDEX idx_expense_splits_payment_status ON expense_splits(payment_status);
```

### 4.4 è´¹ç”¨å®¡æ ¸è¡¨ (expense_reviews)
```sql
CREATE TABLE expense_reviews (
    id BIGSERIAL PRIMARY KEY,
    expense_id BIGINT NOT NULL REFERENCES expenses(id) ON DELETE CASCADE,
    reviewer_id BIGINT NOT NULL REFERENCES users(id),
    status VARCHAR(20) NOT NULL CHECK (status IN ('approved', 'rejected')),
    review_comment TEXT,
    review_data JSONB, -- å®¡æ ¸è¿‡ç¨‹ä¸­çš„é™„åŠ æ•°æ®
    reviewed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(expense_id, reviewer_id)
);

-- ç´¢å¼•
CREATE INDEX idx_expense_reviews_expense_id ON expense_reviews(expense_id);
CREATE INDEX idx_expense_reviews_reviewer_id ON expense_reviews(reviewer_id);
CREATE INDEX idx_expense_reviews_status ON expense_reviews(status);
```

---

## 5. æ”¯ä»˜ç®¡ç†æ¨¡å—

### 5.1 æ”¶æ¬¾ç è¡¨ (payment_codes)
```sql
CREATE TABLE payment_codes (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    payment_type VARCHAR(20) NOT NULL CHECK (payment_type IN ('wechat', 'alipay')),
    qr_code_url TEXT NOT NULL,
    qr_code_filename VARCHAR(255),
    file_size INTEGER, -- æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE, -- æ˜¯å¦å·²éªŒè¯æ”¶æ¬¾ç æœ‰æ•ˆæ€§
    verification_date TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, payment_type, is_active) DEFERRABLE INITIALLY DEFERRED
);

-- ç´¢å¼•
CREATE INDEX idx_payment_codes_user_id ON payment_codes(user_id);
CREATE INDEX idx_payment_codes_type ON payment_codes(payment_type);
CREATE INDEX idx_payment_codes_active ON payment_codes(is_active);
CREATE INDEX idx_payment_codes_verified ON payment_codes(is_verified);

-- ç¡®ä¿åŒä¸€ç”¨æˆ·åŒä¸€æ”¯ä»˜ç±»åž‹åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒçš„æ”¶æ¬¾ç 
ALTER TABLE payment_codes ADD CONSTRAINT chk_active_payment_code_per_user_type 
CHECK (
    NOT (EXISTS (
        SELECT 1 FROM payment_codes pc 
        WHERE pc.user_id = payment_codes.user_id 
        AND pc.payment_type = payment_codes.payment_type 
        AND pc.is_active = TRUE 
        AND pc.id != payment_codes.id
    ))
) DEFERRABLE INITIALLY DEFERRED;
```

### 5.2 æ”¯ä»˜è®°å½•è¡¨ (payments)
```sql
CREATE TABLE payments (
    id BIGSERIAL PRIMARY KEY,
    expense_id BIGINT NOT NULL REFERENCES expenses(id) ON DELETE CASCADE,
    split_id BIGINT REFERENCES expense_splits(id) ON DELETE CASCADE,
    payer_id BIGINT NOT NULL REFERENCES users(id),
    receiver_id BIGINT NOT NULL REFERENCES users(id),
    amount DECIMAL(10,2) NOT NULL CHECK (amount > 0),
    payment_method VARCHAR(20) NOT NULL CHECK (payment_method IN ('wechat', 'alipay', 'cash', 'transfer')),
    status VARCHAR(20) DEFAULT 'pending_confirmation' CHECK (status IN ('pending_confirmation', 'confirmed', 'cancelled', 'disputed')),
    payment_note TEXT,
    confirmation_note TEXT,
    confirmed_by BIGINT REFERENCES users(id),
    confirmed_at TIMESTAMP WITH TIME ZONE,
    payment_time TIMESTAMP WITH TIME ZONE, -- å®žé™…æ”¯ä»˜æ—¶é—´
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    -- æ£€æŸ¥çº¦æŸï¼šä»˜æ¬¾äººå’Œæ”¶æ¬¾äººä¸èƒ½æ˜¯åŒä¸€äºº
    CONSTRAINT chk_payer_receiver_different CHECK (payer_id != receiver_id)
);

-- ç´¢å¼•
CREATE INDEX idx_payments_expense_id ON payments(expense_id);
CREATE INDEX idx_payments_split_id ON payments(split_id);
CREATE INDEX idx_payments_payer_id ON payments(payer_id);
CREATE INDEX idx_payments_receiver_id ON payments(receiver_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_payment_method ON payments(payment_method);
```

### 5.3 è´¦å•è¡¨ (bills)
```sql
CREATE TABLE bills (
    id BIGSERIAL PRIMARY KEY,
    room_id BIGINT NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
    bill_number VARCHAR(50) UNIQUE NOT NULL, -- è´¦å•ç¼–å·
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL CHECK (total_amount >= 0),
    paid_amount DECIMAL(10,2) DEFAULT 0 CHECK (paid_amount >= 0),
    status VARCHAR(20) DEFAULT 'generated' CHECK (status IN ('generated', 'sent', 'partially_paid', 'paid', 'overdue', 'cancelled')),
    due_date DATE,
    sent_at TIMESTAMP WITH TIME ZONE,
    paid_at TIMESTAMP WITH TIME ZONE,
    created_by BIGINT NOT NULL REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_period_valid CHECK (period_start <= period_end),
    CONSTRAINT chk_paid_amount CHECK (paid_amount <= total_amount)
);

-- ç´¢å¼•
CREATE INDEX idx_bills_room_id ON bills(room_id);
CREATE INDEX idx_bills_period ON bills(period_start, period_end);
CREATE INDEX idx_bills_status ON bills(status);
CREATE INDEX idx_bills_due_date ON bills(due_date);
CREATE INDEX idx_bills_created_by ON bills(created_by);
```

### 5.4 è´¦å•æ˜Žç»†è¡¨ (bill_items)
```sql
CREATE TABLE bill_items (
    id BIGSERIAL PRIMARY KEY,
    bill_id BIGINT NOT NULL REFERENCES bills(id) ON DELETE CASCADE,
    expense_id BIGINT NOT NULL REFERENCES expenses(id) ON DELETE CASCADE,
    expense_split_id BIGINT REFERENCES expense_splits(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id),
    amount DECIMAL(10,2) NOT NULL CHECK (amount >= 0),
    payment_status VARCHAR(20) DEFAULT 'unpaid' CHECK (payment_status IN ('unpaid', 'paid', 'partially_paid')),
    paid_amount DECIMAL(10,2) DEFAULT 0 CHECK (paid_amount >= 0),
    due_date DATE,
    paid_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_paid_amount CHECK (paid_amount <= amount)
);

-- ç´¢å¼•
CREATE INDEX idx_bill_items_bill_id ON bill_items(bill_id);
CREATE INDEX idx_bill_items_expense_id ON bill_items(expense_id);
CREATE INDEX idx_bill_items_user_id ON bill_items(user_id);
CREATE INDEX idx_bill_items_payment_status ON bill_items(payment_status);
```

---

## 6. ç³»ç»Ÿç®¡ç†æ¨¡å—

### 6.1 ç³»ç»Ÿé…ç½®è¡¨ (system_configs)
```sql
CREATE TABLE system_configs (
    id SERIAL PRIMARY KEY,
    config_key VARCHAR(100) NOT NULL UNIQUE,
    config_value TEXT NOT NULL,
    config_type VARCHAR(20) DEFAULT 'string' CHECK (config_type IN ('string', 'number', 'boolean', 'json')),
    description TEXT,
    is_public BOOLEAN DEFAULT FALSE, -- æ˜¯å¦å¯å…¬å¼€è®¿é—®
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç³»ç»Ÿé…ç½®ç¤ºä¾‹æ•°æ®
INSERT INTO system_configs (config_key, config_value, config_type, description, is_public) VALUES
('app.name', 'è®°è´¦ç³»ç»Ÿ', 'string', 'åº”ç”¨åç§°', TRUE),
('app.version', '1.0.0', 'string', 'åº”ç”¨ç‰ˆæœ¬', TRUE),
('payment.invitation_code_length', '4', 'number', 'é‚€è¯·ç é•¿åº¦', FALSE),
('payment.max_invitation_uses', '1', 'number', 'é‚€è¯·ç æœ€å¤§ä½¿ç”¨æ¬¡æ•°', FALSE),
('payment.invitation_expire_days', '30', 'number', 'é‚€è¯·ç è¿‡æœŸå¤©æ•°', FALSE),
('expense.max_amount', '999999.99', 'number', 'è´¹ç”¨æœ€å¤§é‡‘é¢', FALSE),
('system.backup_retention_days', '90', 'number', 'å¤‡ä»½ä¿ç•™å¤©æ•°', FALSE);

-- ç´¢å¼•
CREATE INDEX idx_system_configs_key ON system_configs(config_key);
CREATE INDEX idx_system_configs_public ON system_configs(is_public);
```

### 6.2 é€šçŸ¥è¡¨ (notifications)
```sql
CREATE TABLE notifications (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL, -- expense_created, payment_reminder, system_announcementç­‰
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    data JSONB, -- é™„åŠ æ•°æ®
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP WITH TIME ZONE,
    priority VARCHAR(20) DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
    channel VARCHAR(20) DEFAULT 'in_app' CHECK (channel IN ('in_app', 'email', 'sms')),
    sent_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE
);

-- ç´¢å¼•
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_type ON notifications(type);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_priority ON notifications(priority);
CREATE INDEX idx_notifications_created_at ON notifications(created_at);
CREATE INDEX idx_notifications_expires_at ON notifications(expires_at) WHERE expires_at IS NOT NULL;
```

### 6.3 æ“ä½œæ—¥å¿—è¡¨ (audit_logs)
```sql
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    action VARCHAR(100) NOT NULL, -- create_expense, update_user, loginç­‰
    resource_type VARCHAR(50) NOT NULL, -- users, rooms, expensesç­‰
    resource_id VARCHAR(100), -- èµ„æºIDï¼ˆå¯èƒ½æ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰
    old_values JSONB, -- ä¿®æ”¹å‰çš„å€¼
    new_values JSONB, -- ä¿®æ”¹åŽçš„å€¼
    ip_address INET,
    user_agent TEXT,
    session_id VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_resource_identifier CHECK (resource_id IS NOT NULL OR resource_type = 'system')
);

-- ç´¢å¼•
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_ip ON audit_logs(ip_address);
```

---

## 7. ç´¢å¼•ä¸Žæ€§èƒ½ä¼˜åŒ–

### 7.1 ä¸»è¦ç´¢å¼•è®¾è®¡
```sql
-- å¤åˆç´¢å¼•ç”¨äºŽå¤æ‚æŸ¥è¯¢
CREATE INDEX idx_expenses_room_status_date ON expenses(room_id, status, expense_date DESC);
CREATE INDEX idx_payments_receiver_status ON payments(receiver_id, status, created_at DESC);
CREATE INDEX idx_bill_items_user_status ON bill_items(user_id, payment_status, due_date);

-- éƒ¨åˆ†ç´¢å¼•ç”¨äºŽç‰¹å®šæ¡ä»¶æŸ¥è¯¢
CREATE INDEX idx_users_active ON users(id, email, username) WHERE status = 'active';
CREATE INDEX idx_expenses_pending_review ON expenses(id, room_id, created_at) WHERE status = 'pending_review';
CREATE INDEX idx_notifications_unread ON notifications(id, user_id, created_at) WHERE is_read = FALSE;

-- å‡½æ•°ç´¢å¼•ç”¨äºŽå¤æ‚æŸ¥è¯¢
CREATE INDEX idx_users_email_lower ON users(LOWER(email));
CREATE INDEX idx_expenses_title_search ON expenses USING gin(to_tsvector('chinese', title));
```

### 7.2 æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

#### 7.2.1 è´¹ç”¨æŸ¥è¯¢ä¼˜åŒ–
```sql
-- æŽ¨èæŸ¥è¯¢æ¨¡å¼ï¼š
-- 1. æŒ‰å¯å®¤å’Œæ—¶é—´èŒƒå›´æŸ¥è¯¢è´¹ç”¨
SELECT e.*, et.type_display_name 
FROM expenses e 
JOIN expense_types et ON e.expense_type_id = et.id 
WHERE e.room_id = $1 
  AND e.expense_date BETWEEN $2 AND $3 
  AND e.status = 'approved'
ORDER BY e.expense_date DESC;

-- 2. æŒ‰ç”¨æˆ·æŸ¥è¯¢åˆ†æ‘Šè®°å½•
SELECT es.*, e.title, e.amount as expense_amount
FROM expense_splits es
JOIN expenses e ON es.expense_id = e.id
WHERE es.user_id = $1
ORDER BY e.expense_date DESC;
```

#### 7.2.2 æ”¯ä»˜æŸ¥è¯¢ä¼˜åŒ–
```sql
-- æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢ä¼˜åŒ–
SELECT p.*, pr.username as payer_name, rr.username as receiver_name
FROM payments p
JOIN users pr ON p.payer_id = pr.id
JOIN users rr ON p.receiver_id = rr.id
WHERE p.receiver_id = $1
  AND p.status = 'pending_confirmation'
ORDER BY p.created_at DESC;
```

### 7.3 åˆ†åŒºç­–ç•¥

#### 7.3.1 æŒ‰æ—¶é—´åˆ†åŒºï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
```sql
-- æŒ‰æœˆåˆ†åŒºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs_2024_01 PARTITION OF audit_logs
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE audit_logs_2024_02 PARTITION OF audit_logs
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- åˆ›å»ºåˆ†åŒºè¡¨ç®¡ç†å‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partition(table_name text, start_date date)
RETURNS void AS $$
DECLARE
    partition_name text;
    end_date date;
BEGIN
    partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + interval '1 month';
    
    EXECUTE format('CREATE TABLE %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
                   partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

#### 7.3.2 æŒ‰ä¸šåŠ¡åˆ†åŒºï¼ˆè´¹ç”¨è®°å½•ï¼‰
```sql
-- æŒ‰å¯å®¤IDåˆ†åŒºï¼ˆé€‚åˆå¯å®¤æ•°é‡è¾ƒå¤šçš„æƒ…å†µï¼‰
-- éœ€è¦æ ¹æ®å®žé™…å¯å®¤æ•°é‡è®¾è®¡åˆ†åŒºç­–ç•¥
```

---

## 8. æ•°æ®å®‰å…¨ä¸Žå¤‡ä»½

### 8.1 æ•°æ®åŠ å¯†
```sql
-- æ•æ„Ÿå­—æ®µåŠ å¯†ï¼ˆå¯†ç å­—æ®µï¼‰
-- å®žé™…åº”ç”¨ä¸­åº”ä½¿ç”¨åº”ç”¨å±‚åŠ å¯†

-- PIIæ•°æ®åŠ å¯†å»ºè®®
ALTER TABLE users ADD COLUMN phone_encrypted TEXT;
ALTER TABLE users ADD COLUMN email_encrypted TEXT;

-- åˆ›å»ºåŠ å¯†è§£å¯†å‡½æ•°ï¼ˆç¤ºä¾‹ï¼‰
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(data text)
RETURNS text AS $$
BEGIN
    -- è¿™é‡Œåº”è¯¥ä½¿ç”¨é€‚å½“çš„åŠ å¯†ç®—æ³•
    RETURN encode(encrypt(data::bytea, 'key', 'aes'), 'base64');
END;
$$ LANGUAGE plpgsql;
```

### 8.2 å¤‡ä»½ç­–ç•¥
```sql
-- åˆ›å»ºå¤‡ä»½ç›¸å…³å‡½æ•°
CREATE OR REPLACE FUNCTION create_daily_backup()
RETURNS void AS $$
DECLARE
    backup_name text;
BEGIN
    backup_name := 'backup_' || to_char(CURRENT_DATE, 'YYYY_MM_DD');
    
    -- æ‰§è¡Œå¤‡ä»½å‘½ä»¤ï¼ˆéœ€è¦pg_dumpï¼‰
    PERFORM pg_start_backup(backup_name);
    
    -- è¿™é‡Œåº”è¯¥è°ƒç”¨å¤–éƒ¨å¤‡ä»½è„šæœ¬
    -- SYSTEM 'pg_dump -Fc -f ' || backup_name || '.dump accounting_db';
    
    PERFORM pg_stop_backup();
END;
$$ LANGUAGE plpgsql;
```

### 8.3 æ•°æ®æ¸…ç†
```sql
-- æ¸…ç†è¿‡æœŸæ•°æ®
CREATE OR REPLACE FUNCTION cleanup_expired_data()
RETURNS void AS $$
BEGIN
    -- æ¸…ç†è¿‡æœŸçš„é‚€è¯·ç 
    DELETE FROM invitation_codes 
    WHERE expires_at < CURRENT_DATE - interval '30 days';
    
    -- æ¸…ç†å·²è¯»çš„è¿‡æœŸé€šçŸ¥
    DELETE FROM notifications 
    WHERE expires_at < CURRENT_DATE 
      AND is_read = TRUE;
    
    -- æ¸…ç†æ—§çš„å®¡è®¡æ—¥å¿—ï¼ˆä¿ç•™1å¹´ï¼‰
    DELETE FROM audit_logs 
    WHERE created_at < CURRENT_DATE - interval '1 year';
    
    -- æ¸…ç†è¶…è¿‡ä¿ç•™æœŸçš„å¤‡ä»½æ–‡ä»¶
    -- éœ€è¦ç»“åˆæ–‡ä»¶ç³»ç»Ÿä¸­åˆ é™¤å¯¹åº”æ–‡ä»¶
END;
$$ LANGUAGE plpgsql;
```

---

## 9. è§¦å‘å™¨å’Œçº¦æŸ

### 9.1 æ•°æ®ä¸€è‡´æ€§è§¦å‘å™¨
```sql
-- è‡ªåŠ¨æ›´æ–° updated_at å­—æ®µ
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ä¸ºç›¸å…³è¡¨æ·»åŠ è§¦å‘å™¨
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_rooms_updated_at BEFORE UPDATE ON rooms
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_expenses_updated_at BEFORE UPDATE ON expenses
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 9.2 ä¸šåŠ¡é€»è¾‘è§¦å‘å™¨
```sql
-- è´¹ç”¨å®¡æ ¸æ—¶æ›´æ–°çŠ¶æ€
CREATE OR REPLACE FUNCTION update_expense_status()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.status IN ('approved', 'rejected') THEN
        UPDATE expenses 
        SET updated_at = CURRENT_TIMESTAMP 
        WHERE id = NEW.expense_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_expense_status 
    AFTER INSERT OR UPDATE ON expense_reviews
    FOR EACH ROW EXECUTE FUNCTION update_expense_status();

-- æ”¯ä»˜ç¡®è®¤æ—¶æ›´æ–°åˆ†æ‘ŠçŠ¶æ€
CREATE OR REPLACE FUNCTION update_split_payment_status()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.status = 'confirmed' AND OLD.status != 'confirmed' THEN
        UPDATE expense_splits 
        SET payment_status = 'paid', 
            paid_at = NEW.confirmed_at
        WHERE id = NEW.split_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_split_payment_status
    AFTER UPDATE ON payments
    FOR EACH ROW EXECUTE FUNCTION update_split_payment_status();
```

---

## 10. è§†å›¾å’Œå­˜å‚¨è¿‡ç¨‹

### 10.1 å¸¸ç”¨è§†å›¾
```sql
-- å¯å®¤æˆå‘˜å®Œæ•´ä¿¡æ¯è§†å›¾
CREATE VIEW v_room_members_complete AS
SELECT 
    rm.*,
    u.username,
    u.email,
    u.phone,
    u.avatar_url,
    r.room_name,
    r.room_number,
    r.building
FROM room_members rm
JOIN users u ON rm.user_id = u.id
JOIN rooms r ON rm.room_id = r.id
WHERE rm.status = 'active';

-- è´¹ç”¨è¯¦ç»†ä¿¡æ¯è§†å›¾
CREATE VIEW v_expenses_complete AS
SELECT 
    e.*,
    et.type_display_name,
    et.category,
    et.color_code,
    u.username as creator_name,
    r.room_name,
    r.room_number
FROM expenses e
JOIN expense_types et ON e.expense_type_id = et.id
JOIN users u ON e.created_by = u.id
JOIN rooms r ON e.room_id = r.id
WHERE e.deleted_at IS NULL;

-- æ”¯ä»˜ä¿¡æ¯æ±‡æ€»è§†å›¾
CREATE VIEW v_payments_summary AS
SELECT 
    p.*,
    payer.username as payer_name,
    receiver.username as receiver_name,
    e.title as expense_title,
    e.amount as expense_total_amount
FROM payments p
JOIN users payer ON p.payer_id = payer.id
JOIN users receiver ON p.receiver_id = receiver.id
JOIN expenses e ON p.expense_id = e.id;
```

### 10.2 å­˜å‚¨è¿‡ç¨‹
```sql
-- ç”Ÿæˆæœˆè´¦å•
CREATE OR REPLACE FUNCTION generate_monthly_bill(
    p_room_id BIGINT,
    p_year INTEGER,
    p_month INTEGER
)
RETURNS BIGINT AS $$
DECLARE
    v_period_start DATE;
    v_period_end DATE;
    v_bill_id BIGINT;
    v_bill_number TEXT;
    v_total_amount DECIMAL(10,2);
BEGIN
    -- è®¡ç®—è´¦å•å‘¨æœŸ
    v_period_start := make_date(p_year, p_month, 1);
    v_period_end := (make_date(p_year, p_month + 1, 1) - interval '1 day')::DATE;
    
    -- ç”Ÿæˆè´¦å•ç¼–å·
    v_bill_number := 'BILL-' || p_room_id || '-' || p_year || '-' || LPAD(p_month::TEXT, 2, '0');
    
    -- è®¡ç®—æ€»é‡‘é¢
    SELECT COALESCE(SUM(amount), 0) INTO v_total_amount
    FROM expenses e
    WHERE e.room_id = p_room_id
      AND e.expense_date BETWEEN v_period_start AND v_period_end
      AND e.status = 'approved';
    
    -- åˆ›å»ºè´¦å•
    INSERT INTO bills (
        room_id, bill_number, period_start, period_end, 
        total_amount, due_date, created_by
    ) VALUES (
        p_room_id, v_bill_number, v_period_start, v_period_end,
        v_total_amount, v_period_end + interval '7 days',
        (SELECT leader_id FROM rooms WHERE id = p_room_id)
    ) RETURNING id INTO v_bill_id;
    
    RETURN v_bill_id;
END;
$$ LANGUAGE plpgsql;
```

---

*æœ¬æ–‡æ¡£å®šä¹‰äº†è®°è´¦ç³»ç»Ÿçš„å®Œæ•´æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆã€‚åœ¨å®žé™…éƒ¨ç½²æ—¶ï¼Œéœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚å’Œæ€§èƒ½è¦æ±‚è¿›è¡Œé€‚å½“è°ƒæ•´ã€‚å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»æ•°æ®åº“ç®¡ç†å‘˜æˆ–ç³»ç»Ÿæž¶æž„å¸ˆã€‚*